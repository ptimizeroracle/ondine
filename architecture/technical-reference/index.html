
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="SDK for processing tabular datasets with LLMs">
      
      
      
        <link rel="canonical" href="https://ptimizeroracle.github.io/ondine/architecture/technical-reference/">
      
      
        <link rel="prev" href="../../api/integrations/prefect/">
      
      
        <link rel="next" href="../../contributing/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Technical Reference - Ondine Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ondine-complete-technical-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Ondine Documentation" class="md-header__button md-logo" aria-label="Ondine Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ondine Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Technical Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ptimizeroracle/ondine" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ptimizeroracle/ondine
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting-started/installation/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../guides/execution-modes/" class="md-tabs__link">
          
  
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Ondine Documentation" class="md-nav__button md-logo" aria-label="Ondine Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Ondine Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ptimizeroracle/ondine" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ptimizeroracle/ondine
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/core-concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Core Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/execution-modes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Execution Modes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/structured-output/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Structured Output
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/cost-control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cost Control
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Providers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Providers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/providers/openai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenAI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/providers/anthropic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Anthropic Claude
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/providers/groq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Groq
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/providers/azure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Azure OpenAI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/providers/local-mlx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Local MLX
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/providers/custom/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom APIs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/multi-column/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Column Processing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/pipeline-composition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pipeline Composition
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    High-Level API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    High-Level API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/api/pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/api/pipeline_builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PipelineBuilder
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/api/quick/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QuickPipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/api/pipeline_composer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PipelineComposer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/api/dataset_processor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DatasetProcessor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Core
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/core/specifications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Specifications
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/core/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/core/error_handler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Error Handler
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Stages
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Stages
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/stages/pipeline_stage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PipelineStage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/stages/data_loader_stage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Loader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/stages/prompt_formatter_stage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Prompt Formatter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/stages/llm_invocation_stage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Invocation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/stages/response_parser_stage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Response Parser
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/stages/parser_factory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parser Factory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/stages/result_writer_stage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Result Writer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Orchestration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Orchestration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/orchestration/pipeline_executor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pipeline Executor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/orchestration/sync_executor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sync Executor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/orchestration/async_executor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Async Executor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/orchestration/streaming_executor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Streaming Executor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/orchestration/execution_context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Execution Context
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/orchestration/state_manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    State Manager
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/orchestration/observers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Observers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_6" >
        
          
          <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Adapters
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Adapters
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/adapters/llm_client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Client
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/adapters/data_io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data IO
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/adapters/checkpoint_storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Checkpoint Storage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_7" >
        
          
          <label class="md-nav__link" for="__nav_4_7" id="__nav_4_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Utilities
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Utilities
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/cost_tracker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cost Tracker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/budget_controller/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Budget Controller
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/rate_limiter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rate Limiter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/retry_handler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Retry Handler
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/logging_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Logging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_8" >
        
          
          <label class="md-nav__link" for="__nav_4_8" id="__nav_4_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Configuration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/config/config_loader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Config Loader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_9" >
        
          
          <label class="md-nav__link" for="__nav_4_9" id="__nav_4_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    CLI
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/cli/main/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_10" >
        
          
          <label class="md-nav__link" for="__nav_4_10" id="__nav_4_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Integrations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Integrations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/integrations/airflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Airflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/integrations/prefect/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Prefect
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Technical Reference
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Technical Reference
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        Table of Contents
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        Table of Contents
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../.." class="md-path__link">
        
  <span class="md-ellipsis">
    Home
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="./" class="md-path__link">
          
  <span class="md-ellipsis">
    Architecture
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="ondine-complete-technical-reference">Ondine - Complete Technical Reference<a class="headerlink" href="#ondine-complete-technical-reference" title="Permanent link">&para;</a></h1>
<p><strong>Version</strong>: 1.0.0
<strong>Last Updated</strong>: October 18, 2025
<strong>Purpose</strong>: Comprehensive technical documentation of every component, class, design decision, and relationship in the Ondine LLM Dataset Engine.</p>
<p><strong>Quick Navigation</strong>:
- <strong>Architecture Overview &amp; Diagrams</strong>: See <a href="ARCHITECTURE.md"><code>ARCHITECTURE.md</code></a> (auto-generated from <code>architecture/model.yaml</code>)
- <strong>Design Decisions</strong>: See <a href="architecture/decisions/"><code>architecture/decisions/</code></a> (ADRs)
- <strong>Implementation Details</strong>: This document (TECHNICAL_REFERENCE.md)</p>
<p><strong>Note</strong>: This document provides detailed implementation information. For structural relationships and visual diagrams, see <code>ARCHITECTURE.md</code>. For design rationale and trade-offs, see the ADRs.</p>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#part-1-architecture-overview">Part 1: Architecture Overview</a></li>
<li><a href="#part-2-external-dependencies">Part 2: External Dependencies</a></li>
<li><a href="#part-3-layer-0---core-utilities">Part 3: Layer 0 - Core Utilities</a></li>
<li><a href="#part-4-core-models--specifications">Part 4: Core Models &amp; Specifications</a></li>
<li><a href="#part-5-layer-1---infrastructure-adapters">Part 5: Layer 1 - Infrastructure Adapters</a></li>
<li><a href="#part-6-layer-2---processing-stages">Part 6: Layer 2 - Processing Stages</a></li>
<li><a href="#part-7-layer-3---orchestration-engine">Part 7: Layer 3 - Orchestration Engine</a></li>
<li><a href="#part-8-layer-4---high-level-api">Part 8: Layer 4 - High-Level API</a></li>
<li><a href="#part-9-configuration-system">Part 9: Configuration System</a></li>
<li><a href="#part-10-cli-interface">Part 10: CLI Interface</a></li>
<li><a href="#part-11-framework-integrations">Part 11: Framework Integrations</a></li>
<li><a href="#part-12-execution-flows">Part 12: Execution Flows</a></li>
<li><a href="#part-13-data-flows">Part 13: Data Flows</a></li>
<li><a href="#part-14-extension-points">Part 14: Extension Points</a></li>
</ul>
<hr />
<h1 id="part-1-architecture-overview">Part 1: Architecture Overview<a class="headerlink" href="#part-1-architecture-overview" title="Permanent link">&para;</a></h1>
<h2 id="11-system-architecture">1.1 System Architecture<a class="headerlink" href="#11-system-architecture" title="Permanent link">&para;</a></h2>
<p>Ondine follows a <strong>5-layer architecture</strong>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>graph TB
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    subgraph &quot;Layer 4: High-Level API&quot;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        API[Pipeline]
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        Builder[PipelineBuilder]
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        Composer[PipelineComposer]
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        Processor[DatasetProcessor]
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    end
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    subgraph &quot;Layer 3: Orchestration&quot;
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        Executor[PipelineExecutor]
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        Strategy[ExecutionStrategy]
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        SyncExec[SyncExecutor]
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        AsyncExec[AsyncExecutor]
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        StreamExec[StreamingExecutor]
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        Context[ExecutionContext]
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        StateManager[StateManager]
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        Observers[Observers]
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    end
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    subgraph &quot;Layer 2: Processing Stages&quot;
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        DataLoader[DataLoaderStage]
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        PromptFormatter[PromptFormatterStage]
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        BatchAgg[BatchAggregatorStage]
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        LLMInvocation[LLMInvocationStage]
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        BatchDisagg[BatchDisaggregatorStage]
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        ResponseParser[ResponseParserStage]
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        ResultWriter[ResultWriterStage]
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    end
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    subgraph &quot;Layer 1: Infrastructure Adapters&quot;
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        LLMClient[LLM Client]
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        DataIO[Data I/O]
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        Checkpoint[Checkpoint Storage]
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    end
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    subgraph &quot;Layer 0: Utilities&quot;
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        Retry[RetryHandler]
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        RateLimit[RateLimiter]
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        Cost[CostTracker]
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        Budget[BudgetController]
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        Logging[Logging Utils]
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    end
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    API --&gt; Executor
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    Builder --&gt; API
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    Executor --&gt; Strategy
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    Strategy --&gt; SyncExec
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    Strategy --&gt; AsyncExec
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>    Strategy --&gt; StreamExec
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    Executor --&gt; Context
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>    Executor --&gt; StateManager
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>    Executor --&gt; Observers
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>    Executor --&gt; DataLoader
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    DataLoader --&gt; PromptFormatter
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    PromptFormatter --&gt; BatchAgg
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>    BatchAgg --&gt; LLMInvocation
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>    LLMInvocation --&gt; BatchDisagg
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>    BatchDisagg --&gt; ResponseParser
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>    ResponseParser --&gt; ResultWriter
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>    LLMInvocation --&gt; LLMClient
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>    DataLoader --&gt; DataIO
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>    ResultWriter --&gt; DataIO
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>    StateManager --&gt; Checkpoint
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>    LLMInvocation --&gt; Retry
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>    LLMInvocation --&gt; RateLimit
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>    LLMInvocation --&gt; Cost
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>    Executor --&gt; Budget
</span></code></pre></div>
<h3 id="layer-responsibilities">Layer Responsibilities<a class="headerlink" href="#layer-responsibilities" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Layer</th>
<th>Directory</th>
<th>Purpose</th>
<th>Dependencies</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Layer 0</strong></td>
<td><code>utils/</code></td>
<td>Cross-cutting concerns (retry, rate limiting, cost tracking)</td>
<td>External libraries only</td>
</tr>
<tr>
<td><strong>Layer 1</strong></td>
<td><code>adapters/</code></td>
<td>External system integrations (LLM providers, file I/O)</td>
<td>Layer 0 + external APIs</td>
</tr>
<tr>
<td><strong>Layer 2</strong></td>
<td><code>stages/</code></td>
<td>Data transformation logic (load, format, batch, invoke, parse, write)</td>
<td>Layers 0-1</td>
</tr>
<tr>
<td><strong>Layer 3</strong></td>
<td><code>orchestration/</code></td>
<td>Execution control and state management</td>
<td>Layers 0-2</td>
</tr>
<tr>
<td><strong>Layer 4</strong></td>
<td><code>api/</code></td>
<td>User-facing interfaces (Pipeline, Builder)</td>
<td>All layers</td>
</tr>
</tbody>
</table>
<h3 id="key-design-principles">Key Design Principles<a class="headerlink" href="#key-design-principles" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Dependency Rule</strong>: Dependencies only point inward (higher layers depend on lower layers, never the reverse)</li>
<li><strong>Focused Components</strong>: Each component has one clear purpose</li>
<li><strong>Extensible</strong>: Open for extension, closed for modification</li>
<li><strong>Abstraction</strong>: Depend on abstractions, not concretions</li>
<li><strong>Simple</strong>: Keep it simple</li>
</ol>
<h2 id="12-design-patterns-catalog">1.2 Design Patterns Catalog<a class="headerlink" href="#12-design-patterns-catalog" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Where Used</th>
<th>Purpose</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Facade</strong></td>
<td><code>Pipeline</code></td>
<td>Simplify complex subsystem</td>
<td>Hides orchestration complexity</td>
</tr>
<tr>
<td><strong>Builder</strong></td>
<td><code>PipelineBuilder</code></td>
<td>Fluent construction API</td>
<td>Chainable method calls</td>
</tr>
<tr>
<td><strong>Strategy</strong></td>
<td><code>ExecutionStrategy</code></td>
<td>Pluggable execution modes</td>
<td><code>SyncExecutor</code>, <code>AsyncExecutor</code>, <code>StreamingExecutor</code></td>
</tr>
<tr>
<td><strong>Template Method</strong></td>
<td><code>PipelineStage.execute()</code></td>
<td>Standardized stage flow</td>
<td>Base class with hooks</td>
</tr>
<tr>
<td><strong>Observer</strong></td>
<td><code>ExecutionObserver</code></td>
<td>Monitoring hooks</td>
<td><code>ProgressObserver</code>, <code>CostObserver</code>, <code>LoggingObserver</code></td>
</tr>
<tr>
<td><strong>Adapter</strong></td>
<td><code>LLMClient</code>, <code>DataReader</code></td>
<td>Interface translation</td>
<td>Wrap external libraries</td>
</tr>
<tr>
<td><strong>Factory</strong></td>
<td><code>ParserFactory</code></td>
<td>Object creation</td>
<td>Create parsers by type</td>
</tr>
<tr>
<td><strong>Composite</strong></td>
<td><code>PipelineComposer</code></td>
<td>Tree structure</td>
<td>Compose pipelines</td>
</tr>
<tr>
<td><strong>Singleton</strong></td>
<td>Config instances</td>
<td>Single instance</td>
<td>Via module-level state</td>
</tr>
<tr>
<td><strong>Chain of Responsibility</strong></td>
<td>Stage pipeline</td>
<td>Sequential processing</td>
<td>Each stage processes then passes</td>
</tr>
<tr>
<td><strong>Protocol</strong></td>
<td><code>TextCleaner</code></td>
<td>Structural typing</td>
<td>Duck typing with validation</td>
</tr>
<tr>
<td><strong>Memento</strong></td>
<td><code>ExecutionContext</code></td>
<td>State capture</td>
<td>Serializable state</td>
</tr>
</tbody>
</table>
<h2 id="13-thread-safety-strategy">1.3 Thread Safety Strategy<a class="headerlink" href="#13-thread-safety-strategy" title="Permanent link">&para;</a></h2>
<h3 id="thread-safe-components">Thread-Safe Components<a class="headerlink" href="#thread-safe-components" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Mechanism</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CostTracker</code></td>
<td><code>threading.Lock</code></td>
<td>Shared cost accumulation</td>
</tr>
<tr>
<td><code>RateLimiter</code></td>
<td><code>threading.Lock</code></td>
<td>Token bucket state</td>
</tr>
<tr>
<td><code>CheckpointStorage</code></td>
<td>File-based locks</td>
<td>Concurrent writes</td>
</tr>
<tr>
<td><code>LLMInvocationStage</code></td>
<td><code>ThreadPoolExecutor</code></td>
<td>Concurrent LLM calls</td>
</tr>
</tbody>
</table>
<h3 id="thread-unsafe-components-by-design">Thread-Unsafe Components (By Design)<a class="headerlink" href="#thread-unsafe-components-by-design" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Why Not Thread-Safe</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PipelineBuilder</code></td>
<td>Construction phase only, not shared</td>
</tr>
<tr>
<td><code>Pipeline</code> (single exec)</td>
<td>Each execution is sequential</td>
</tr>
<tr>
<td><code>DataLoaderStage</code></td>
<td>Reads once, no shared state</td>
</tr>
</tbody>
</table>
<hr />
<h1 id="part-2-external-dependencies">Part 2: External Dependencies<a class="headerlink" href="#part-2-external-dependencies" title="Permanent link">&para;</a></h1>
<h2 id="21-dependency-catalog">2.1 Dependency Catalog<a class="headerlink" href="#21-dependency-catalog" title="Permanent link">&para;</a></h2>
<h3 id="production-dependencies-20-libraries">Production Dependencies (20 libraries)<a class="headerlink" href="#production-dependencies-20-libraries" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Library</th>
<th>Version</th>
<th>Category</th>
<th>License</th>
<th>Why Chosen</th>
<th>Alternatives Considered</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>llama-index</strong></td>
<td>&gt;=0.12.0</td>
<td>LLM</td>
<td>MIT</td>
<td>LLM provider clients (OpenAI, Anthropic, Groq). Ondine adds batch orchestration, cost tracking, checkpointing, YAML config.</td>
<td>LangChain (more complex), direct APIs (no abstraction)</td>
</tr>
<tr>
<td><strong>llama-index-llms-openai</strong></td>
<td>&gt;=0.3.0</td>
<td>LLM</td>
<td>MIT</td>
<td>Official OpenAI integration</td>
<td><code>openai</code> package (less abstraction)</td>
</tr>
<tr>
<td><strong>llama-index-llms-azure-openai</strong></td>
<td>&gt;=0.3.0</td>
<td>LLM</td>
<td>MIT</td>
<td>Enterprise Azure support</td>
<td>Custom Azure client</td>
</tr>
<tr>
<td><strong>llama-index-llms-anthropic</strong></td>
<td>&gt;=0.3.0</td>
<td>LLM</td>
<td>MIT</td>
<td>Claude integration</td>
<td><code>anthropic</code> package (less abstraction)</td>
</tr>
<tr>
<td><strong>llama-index-llms-groq</strong></td>
<td>&gt;=0.3.0</td>
<td>LLM</td>
<td>MIT</td>
<td>Fast, affordable inference</td>
<td>Direct Groq API</td>
</tr>
<tr>
<td><strong>pandas</strong></td>
<td>&gt;=2.0.0</td>
<td>Data</td>
<td>BSD-3</td>
<td>Industry standard, rich API</td>
<td>Polars (less mature ecosystem)</td>
</tr>
<tr>
<td><strong>polars</strong></td>
<td>&gt;=0.20.0</td>
<td>Data</td>
<td>MIT</td>
<td>Fast Parquet reading</td>
<td>Pandas (slower for large files)</td>
</tr>
<tr>
<td><strong>pydantic</strong></td>
<td>&gt;=2.0.0</td>
<td>Validation</td>
<td>MIT</td>
<td>Validation + serialization + type hints</td>
<td>dataclasses (no validation), marshmallow (complex)</td>
</tr>
<tr>
<td><strong>python-dotenv</strong></td>
<td>&gt;=1.0.0</td>
<td>Config</td>
<td>BSD-3</td>
<td>Simple .env loading</td>
<td>os.environ (manual)</td>
</tr>
<tr>
<td><strong>tqdm</strong></td>
<td>&gt;=4.66.0</td>
<td>UI</td>
<td>MPL/MIT</td>
<td>Simple, widely used progress bars</td>
<td>rich.progress (overkill), progressbar2</td>
</tr>
<tr>
<td><strong>tenacity</strong></td>
<td>&gt;=8.2.0</td>
<td>Reliability</td>
<td>Apache-2.0</td>
<td>Flexible retry logic</td>
<td><code>backoff</code> (simpler but less flexible)</td>
</tr>
<tr>
<td><strong>openpyxl</strong></td>
<td>&gt;=3.1.0</td>
<td>Data</td>
<td>MIT</td>
<td>Excel file support</td>
<td>xlrd (deprecated), pyexcel</td>
</tr>
<tr>
<td><strong>pyarrow</strong></td>
<td>&gt;=15.0.0</td>
<td>Data</td>
<td>Apache-2.0</td>
<td>Fast Parquet I/O</td>
<td>fastparquet (slower)</td>
</tr>
<tr>
<td><strong>tiktoken</strong></td>
<td>&gt;=0.5.0</td>
<td>LLM</td>
<td>MIT</td>
<td>Fast token counting, OpenAI-native</td>
<td>transformers (slower), estimate (inaccurate)</td>
</tr>
<tr>
<td><strong>structlog</strong></td>
<td>&gt;=24.0.0</td>
<td>Logging</td>
<td>MIT/Apache</td>
<td>Structured logging, JSON output</td>
<td>standard logging (unstructured)</td>
</tr>
<tr>
<td><strong>jinja2</strong></td>
<td>&gt;=3.1.0</td>
<td>Templating</td>
<td>BSD-3</td>
<td>Powerful prompt templating</td>
<td>string.Template (too simple), mako</td>
</tr>
<tr>
<td><strong>prometheus-client</strong></td>
<td>&gt;=0.20.0</td>
<td>Monitoring</td>
<td>Apache-2.0</td>
<td>Industry standard metrics</td>
<td>Custom metrics (reinvent wheel)</td>
</tr>
<tr>
<td><strong>click</strong></td>
<td>&gt;=8.1.0</td>
<td>CLI</td>
<td>BSD-3</td>
<td>Decorator-based, simple</td>
<td>argparse (verbose), typer (overkill)</td>
</tr>
<tr>
<td><strong>rich</strong></td>
<td>&gt;=13.0.0</td>
<td>CLI</td>
<td>MIT</td>
<td>Beautiful tables and formatting</td>
<td>colorama (basic), termcolor</td>
</tr>
</tbody>
</table>
<h3 id="dev-dependencies-8-libraries">Dev Dependencies (8 libraries)<a class="headerlink" href="#dev-dependencies-8-libraries" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Library</th>
<th>Purpose</th>
<th>Why Chosen</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>pytest</strong></td>
<td>Testing framework</td>
<td>Industry standard, rich plugins</td>
</tr>
<tr>
<td><strong>pytest-cov</strong></td>
<td>Coverage reporting</td>
<td>Integrates with pytest</td>
</tr>
<tr>
<td><strong>pytest-asyncio</strong></td>
<td>Async test support</td>
<td>Test async executors</td>
</tr>
<tr>
<td><strong>black</strong></td>
<td>Code formatting</td>
<td>Opinionated, consistent</td>
</tr>
<tr>
<td><strong>ruff</strong></td>
<td>Fast linting</td>
<td>Faster than flake8/pylint</td>
</tr>
<tr>
<td><strong>mypy</strong></td>
<td>Type checking</td>
<td>Catch type errors</td>
</tr>
<tr>
<td><strong>ipython</strong></td>
<td>Interactive shell</td>
<td>Better REPL</td>
</tr>
<tr>
<td><strong>jupyter</strong></td>
<td>Notebooks</td>
<td>Interactive exploration</td>
</tr>
</tbody>
</table>
<h3 id="optional-dependencies-1-group">Optional Dependencies (1 group)<a class="headerlink" href="#optional-dependencies-1-group" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Group</th>
<th>Libraries</th>
<th>Purpose</th>
<th>Platform</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>mlx</strong></td>
<td>mlx&gt;=0.29.0, mlx-lm&gt;=0.28.0</td>
<td>Apple Silicon local inference</td>
<td>macOS only (M1/M2/M3/M4)</td>
</tr>
</tbody>
</table>
<p><strong>Installation</strong>: <code>pip install ondine[mlx]</code></p>
<h2 id="22-dependency-graph">2.2 Dependency Graph<a class="headerlink" href="#22-dependency-graph" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>graph TD
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    Ondine[Ondine Core]
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    Ondine --&gt; LI[llama-index]
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    Ondine --&gt; Pandas
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    Ondine --&gt; Pydantic
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    Ondine --&gt; Structlog
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    Ondine --&gt; Click
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    Ondine --&gt; Rich
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    LI --&gt; LIOAI[llama-index-llms-openai]
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    LI --&gt; LIAZ[llama-index-llms-azure]
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    LI --&gt; LIANT[llama-index-llms-anthropic]
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    LI --&gt; LIGR[llama-index-llms-groq]
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    Pandas --&gt; Openpyxl[openpyxl]
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>    Pandas --&gt; Polars
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    Ondine --&gt; Tiktoken[tiktoken]
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    Ondine --&gt; Tenacity[tenacity]
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    Ondine --&gt; Tqdm[tqdm]
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>    Ondine --&gt; Jinja2[jinja2]
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>    Ondine --&gt; Prometheus[prometheus-client]
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    Ondine --&gt; Dotenv[python-dotenv]
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>    Ondine -.-&gt; MLX[mlx + mlx-lm]
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>    MLX -.-&gt; MLXMetal[mlx-metal]
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>    Polars --&gt; PyArrow[pyarrow]
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>    style MLX stroke-dasharray: 5 5
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>    style MLXMetal stroke-dasharray: 5 5
</span></code></pre></div>
<p><strong>Note</strong>: Dashed lines indicate optional dependencies (<code>pip install ondine[mlx]</code>)</p>
<h3 id="critical-dependencies-cannot-be-removed">Critical Dependencies (Cannot Be Removed)<a class="headerlink" href="#critical-dependencies-cannot-be-removed" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>llama-index</strong> - Core dependency providing:</li>
<li><strong>LLM provider clients</strong> (OpenAI, Anthropic, Groq, Azure)</li>
<li><strong>Observability instrumentation</strong> (automatic LLM call tracking)</li>
<li><strong>Future RAG</strong> capabilities (vector stores, query engines)</li>
<li>Ondine wraps with: batch orchestration, cost tracking, checkpointing, YAML config</li>
<li><strong>pandas</strong> - Data manipulation backbone, used throughout</li>
<li><strong>pydantic</strong> - Configuration validation, type safety</li>
<li><strong>structlog</strong> - Structured logging, observability</li>
<li><strong>opentelemetry-api + opentelemetry-sdk</strong> - Observability infrastructure (via LlamaIndex)</li>
<li><strong>langfuse</strong> - LLM-specific observability platform (via LlamaIndex)</li>
</ol>
<h3 id="optional-dependencies-can-be-removed">Optional Dependencies (Can Be Removed)<a class="headerlink" href="#optional-dependencies-can-be-removed" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>polars</strong> - Only for fast Parquet reading, pandas can handle it (slower)</li>
<li><strong>prometheus-client</strong> - Only for metrics export, can be disabled</li>
<li><strong>rich</strong> - Only for CLI pretty printing, can fall back to basic output</li>
<li><strong>jinja2</strong> - Only for advanced templating, can use string.format()</li>
<li><strong>mlx + mlx-lm</strong> - Only for Apple Silicon local inference, use cloud providers instead</li>
</ol>
<hr />
<h1 id="part-5-layer-1-infrastructure-adapters-llm-providers">Part 5: Layer 1 - Infrastructure Adapters (LLM Providers)<a class="headerlink" href="#part-5-layer-1-infrastructure-adapters-llm-providers" title="Permanent link">&para;</a></h1>
<h2 id="51-llm-provider-overview">5.1 LLM Provider Overview<a class="headerlink" href="#51-llm-provider-overview" title="Permanent link">&para;</a></h2>
<p>Ondine supports multiple LLM providers through the <strong>Adapter pattern</strong>, allowing easy switching between providers without changing core logic.</p>
<h3 id="supported-providers">Supported Providers<a class="headerlink" href="#supported-providers" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Category</th>
<th>Platform</th>
<th>Cost</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>OpenAI</strong></td>
<td>Cloud API</td>
<td>All</td>
<td>$$</td>
<td>Production, high quality</td>
</tr>
<tr>
<td><strong>Azure OpenAI</strong></td>
<td>Cloud API</td>
<td>All</td>
<td>$$</td>
<td>Enterprise, compliance, <strong>Managed Identity support</strong></td>
</tr>
<tr>
<td><strong>Anthropic</strong></td>
<td>Cloud API</td>
<td>All</td>
<td>$$$</td>
<td>Claude models, long context</td>
</tr>
<tr>
<td><strong>Groq</strong></td>
<td>Cloud API</td>
<td>All</td>
<td>Free tier</td>
<td>Fast inference, development</td>
</tr>
<tr>
<td><strong>OpenAI-Compatible</strong></td>
<td>Custom/Local/Cloud</td>
<td>All</td>
<td>Varies</td>
<td>Ollama, vLLM, Together.AI, custom APIs</td>
</tr>
</tbody>
</table>
<h3 id="provider-selection-guide">Provider Selection Guide<a class="headerlink" href="#provider-selection-guide" title="Permanent link">&para;</a></h3>
<p><strong>Choose OpenAI if</strong>: Production quality, mature ecosystem, GPT-4
<strong>Choose Azure if</strong>: Enterprise compliance, private deployments, keyless authentication
<strong>Choose Anthropic if</strong>: Claude models, 100K+ context
<strong>Choose Groq if</strong>: Fast inference, free tier, development
<strong>Choose OpenAI-Compatible if</strong>: Custom endpoints, Ollama, vLLM, Together.AI, self-hosted</p>
<hr />
<h2 id="52-openai-compatible-provider-custom-apis">5.2 OpenAI-Compatible Provider (Custom APIs)<a class="headerlink" href="#52-openai-compatible-provider-custom-apis" title="Permanent link">&para;</a></h2>
<h3 id="purpose">Purpose<a class="headerlink" href="#purpose" title="Permanent link">&para;</a></h3>
<p>Enable integration with any LLM API that implements the OpenAI chat completions format.</p>
<h3 id="class-openaicompatibleclient">Class: <code>OpenAICompatibleClient</code><a class="headerlink" href="#class-openaicompatibleclient" title="Permanent link">&para;</a></h3>
<p><strong>Inheritance</strong>: <code>LLMClient</code> (Adapter pattern)</p>
<p><strong>Platform</strong>: All (platform-agnostic)</p>
<p><strong>Responsibility</strong>: Connect to custom OpenAI-compatible API endpoints</p>
<p><strong>Supports</strong>:
- <strong>Ollama</strong> (local LLM server)
- <strong>vLLM</strong> (self-hosted inference)
- <strong>Together.AI</strong> (cloud API)
- <strong>Anyscale</strong> (cloud API)
- <strong>LocalAI</strong> (self-hosted)
- <strong>Any custom OpenAI-compatible API</strong></p>
<h3 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h3>
<p><strong>Required Fields</strong>:
- <code>provider: openai_compatible</code>
- <code>base_url</code>: Custom API endpoint URL
- <code>model</code>: Model identifier</p>
<p><strong>Optional Fields</strong>:
- <code>provider_name</code>: Custom name for logging/metrics
- <code>api_key</code>: Authentication (or use env var, or "dummy" for local)
- <code>input_cost_per_1k_tokens</code>: Custom pricing
- <code>output_cost_per_1k_tokens</code>: Custom pricing</p>
<h3 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">OpenAICompatibleClient</span><span class="p">(</span><span class="n">LLMClient</span><span class="p">):</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">LLMSpec</span><span class="p">):</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>        <span class="c1"># Validate base_url is provided</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>        <span class="c1"># Initialize OpenAI client with custom base_url</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>        <span class="c1"># Use provider_name for metrics</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>        <span class="c1"># Call custom API using OpenAI format</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>        <span class="c1"># Return standardized LLMResponse</span>
</span></code></pre></div>
<p><strong>Design Decision: Reuse OpenAI Client</strong></p>
<p>Instead of reimplementing HTTP calls, leverage llama-index's OpenAI client with custom <code>api_base</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    <span class="n">model</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span> <span class="ow">or</span> <span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="n">api_base</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span>  <span class="c1"># Custom URL</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="p">)</span>
</span></code></pre></div>
<p><strong>Rationale</strong>:
- DRY: Reuse existing, well-tested code
- Reliability: llama-index handles edge cases
- Compatibility: Ensures OpenAI format compliance
- Maintainability: Updates to OpenAI client benefit us</p>
<h3 id="example-configurations">Example Configurations<a class="headerlink" href="#example-configurations" title="Permanent link">&para;</a></h3>
<h4 id="local-ollama-free">Local Ollama (Free)<a class="headerlink" href="#local-ollama-free" title="Permanent link">&para;</a></h4>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nt">llm</span><span class="p">:</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openai_compatible</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">  </span><span class="nt">provider_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Ollama-Local&quot;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">  </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">llama3.1:70b</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">  </span><span class="nt">base_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost:11434/v1</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">  </span><span class="c1"># No API key needed</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">  </span><span class="nt">input_cost_per_1k_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">  </span><span class="nt">output_cost_per_1k_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span></code></pre></div>
<h4 id="togetherai-cloud">Together.AI (Cloud)<a class="headerlink" href="#togetherai-cloud" title="Permanent link">&para;</a></h4>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nt">llm</span><span class="p">:</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openai_compatible</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">  </span><span class="nt">provider_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Together.AI&quot;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">  </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">meta-llama/Meta-Llama-3.1-70B-Instruct-Turbo</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">  </span><span class="nt">base_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://api.together.xyz/v1</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">  </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\${TOGETHER_API_KEY}</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">  </span><span class="nt">input_cost_per_1k_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0006</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">  </span><span class="nt">output_cost_per_1k_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0006</span>
</span></code></pre></div>
<h4 id="self-hosted-vllm">Self-Hosted vLLM<a class="headerlink" href="#self-hosted-vllm" title="Permanent link">&para;</a></h4>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">llm</span><span class="p">:</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openai_compatible</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="nt">provider_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;vLLM-Custom&quot;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">meta-llama/Llama-3.1-70B-Instruct</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">  </span><span class="nt">base_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://your-vllm-server:8000/v1</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="nt">input_cost_per_1k_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span><span class="w">  </span><span class="c1"># Self-hosted = free</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">  </span><span class="nt">output_cost_per_1k_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span></code></pre></div>
<h3 id="validation">Validation<a class="headerlink" href="#validation" title="Permanent link">&para;</a></h3>
<p><strong>Pydantic Model Validator</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate_provider_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LLMSpec&quot;</span><span class="p">:</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">LLMProvider</span><span class="o">.</span><span class="n">OPENAI_COMPATIBLE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;base_url required for openai_compatible provider&quot;</span><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="k">return</span> <span class="bp">self</span>
</span></code></pre></div></p>
<p><strong>Design</strong>: Fail fast with clear error message</p>
<h3 id="token-estimation">Token Estimation<a class="headerlink" href="#token-estimation" title="Permanent link">&para;</a></h3>
<p>Uses tiktoken with cl100k_base encoding (approximation):
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="s2">&quot;cl100k_base&quot;</span><span class="p">)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
</span></code></pre></div></p>
<p><strong>Tradeoff</strong>: Not model-specific, but consistent and fast</p>
<h3 id="performance-characteristics">Performance Characteristics<a class="headerlink" href="#performance-characteristics" title="Permanent link">&para;</a></h3>
<p><strong>Depends on backend</strong>:
- <strong>Ollama local</strong>: ~10-20 tokens/sec (70B model, single GPU)
- <strong>vLLM multi-GPU</strong>: ~50-80 tokens/sec (70B model, tensor parallel)
- <strong>Together.AI cloud</strong>: ~30-50 tokens/sec (network latency)</p>
<h3 id="authentication-handling">Authentication Handling<a class="headerlink" href="#authentication-handling" title="Permanent link">&para;</a></h3>
<p><strong>Priority order</strong>:
1. <code>spec.api_key</code> (explicit in config)
2. <code>OPENAI_COMPATIBLE_API_KEY</code> env var
3. <code>"dummy"</code> fallback (for local APIs without auth)</p>
<p><strong>Design</strong>: Flexible authentication for different scenarios</p>
<h3 id="provider-naming">Provider Naming<a class="headerlink" href="#provider-naming" title="Permanent link">&para;</a></h3>
<p>The <code>provider_name</code> field appears in metrics/logging:
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">model</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="c1"># Example: &quot;Together.AI/meta-llama/Llama-3.1-70B&quot;</span>
</span></code></pre></div></p>
<p><strong>Benefit</strong>: Clear identification in logs and cost tracking</p>
<h3 id="dependencies">Dependencies<a class="headerlink" href="#dependencies" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">llama_index.llms.openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>  <span class="c1"># Reuse OpenAI client</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tiktoken</span>  <span class="c1"># Token estimation</span>
</span></code></pre></div>
<h3 id="used-by">Used By<a class="headerlink" href="#used-by" title="Permanent link">&para;</a></h3>
<ul>
<li><code>create_llm_client()</code> factory</li>
<li>Any pipeline with <code>provider: openai_compatible</code></li>
<li>Examples: Ollama, Together.AI, vLLM configs</li>
</ul>
<h3 id="testing-strategy">Testing Strategy<a class="headerlink" href="#testing-strategy" title="Permanent link">&para;</a></h3>
<p><strong>Unit Tests (14 tests)</strong>:
- Validation (base_url requirement)
- Provider naming
- Dummy API keys for local APIs
- Cost calculation with custom pricing
- Factory integration
- Backward compatibility</p>
<h3 id="known-limitations">Known Limitations<a class="headerlink" href="#known-limitations" title="Permanent link">&para;</a></h3>
<ul>
<li>Assumes OpenAI-compatible format (doesn't support exotic APIs)</li>
<li>Token counting is approximate (cl100k_base encoding)</li>
<li>Can't use provider-specific features (only OpenAI format)</li>
</ul>
<h3 id="future-improvements">Future Improvements<a class="headerlink" href="#future-improvements" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Support custom headers (for exotic auth)</li>
<li>[ ] Add provider-specific tokenizers</li>
<li>[ ] Support streaming responses</li>
<li>[ ] Add connection pooling for performance</li>
</ul>
<hr />
<hr />
<h1 id="part-3-layer-0-core-utilities">Part 3: Layer 0 - Core Utilities<a class="headerlink" href="#part-3-layer-0-core-utilities" title="Permanent link">&para;</a></h1>
<h2 id="31-overview">3.1 Overview<a class="headerlink" href="#31-overview" title="Permanent link">&para;</a></h2>
<p>Layer 0 provides cross-cutting concerns that are used throughout the system:
- Retry logic with exponential backoff
- Rate limiting (token bucket algorithm)
- Cost tracking and accumulation
- Budget enforcement
- Structured logging
- Metrics export (Prometheus)
- Input text preprocessing</p>
<p><strong>Design Principle</strong>: These utilities have <strong>no dependencies on higher layers</strong>, only on external libraries.</p>
<hr />
<h2 id="32-utilsretry_handlerpy">3.2 <code>utils/retry_handler.py</code><a class="headerlink" href="#32-utilsretry_handlerpy" title="Permanent link">&para;</a></h2>
<h3 id="purpose_1">Purpose<a class="headerlink" href="#purpose_1" title="Permanent link">&para;</a></h3>
<p>Implements robust retry logic with exponential backoff for transient failures.</p>
<h3 id="classes">Classes<a class="headerlink" href="#classes" title="Permanent link">&para;</a></h3>
<h4 id="retryableerror-exception"><code>RetryableError</code> (Exception)<a class="headerlink" href="#retryableerror-exception" title="Permanent link">&para;</a></h4>
<p><strong>Inheritance</strong>: <code>Exception</code></p>
<p><strong>Purpose</strong>: Base class for errors that should be retried</p>
<p><strong>Design Decision</strong>: Create custom exception hierarchy to distinguish retryable vs. non-retryable errors</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">RetryableError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for errors that should be retried.&quot;&quot;&quot;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="k">pass</span>
</span></code></pre></div>
<h4 id="ratelimiterror-exception"><code>RateLimitError</code> (Exception)<a class="headerlink" href="#ratelimiterror-exception" title="Permanent link">&para;</a></h4>
<p><strong>Inheritance</strong>: <code>RetryableError</code></p>
<p><strong>Purpose</strong>: Specific error for rate limit scenarios</p>
<p><strong>Usage</strong>: Raised by LLM clients when rate limits are hit</p>
<h4 id="networkerror-exception"><code>NetworkError</code> (Exception)<a class="headerlink" href="#networkerror-exception" title="Permanent link">&para;</a></h4>
<p><strong>Inheritance</strong>: <code>RetryableError</code></p>
<p><strong>Purpose</strong>: Specific error for network-related failures</p>
<p><strong>Usage</strong>: Raised when network calls fail transiently</p>
<h4 id="retryhandler-class"><code>RetryHandler</code> (Class)<a class="headerlink" href="#retryhandler-class" title="Permanent link">&para;</a></h4>
<p><strong>Responsibility</strong>: Handle retry logic with configurable exponential backoff</p>
<p><strong>Single Responsibility</strong>: ONLY handles retry logic, nothing else</p>
<p><strong>Attributes</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span>           <span class="c1"># Maximum retry attempts (default: 3)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">initial_delay</span><span class="p">:</span> <span class="nb">float</span>        <span class="c1"># Initial delay in seconds (default: 1.0)</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">max_delay</span><span class="p">:</span> <span class="nb">float</span>            <span class="c1"># Maximum delay cap (default: 60.0)</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">exponential_base</span><span class="p">:</span> <span class="nb">int</span>       <span class="c1"># Base for exponential calculation (default: 2)</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">retryable_exceptions</span><span class="p">:</span> <span class="nb">tuple</span> <span class="c1"># Which exceptions to retry</span>
</span></code></pre></div></p>
<p><strong>Methods</strong>:</p>
<h5 id="__init__max_attempts-initial_delay-max_delay-exponential_base-retryable_exceptions"><code>__init__(max_attempts, initial_delay, max_delay, exponential_base, retryable_exceptions)</code><a class="headerlink" href="#__init__max_attempts-initial_delay-max_delay-exponential_base-retryable_exceptions" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Initialize retry configuration</p>
<p><strong>Parameters</strong>:
- <code>max_attempts: int = 3</code> - How many times to retry
- <code>initial_delay: float = 1.0</code> - Starting delay
- <code>max_delay: float = 60.0</code> - Maximum delay cap
- <code>exponential_base: int = 2</code> - Exponent base (delay = initial * base^attempt)
- <code>retryable_exceptions: Optional[tuple] = None</code> - Which exceptions trigger retry</p>
<p><strong>Design Decision</strong>: Make all parameters configurable for flexibility across different failure scenarios</p>
<p><strong>Default Behavior</strong>: If <code>retryable_exceptions</code> is None, defaults to <code>(RetryableError, RateLimitError, NetworkError)</code></p>
<h5 id="executefunc-callable-t-t"><code>execute(func: Callable[[], T]) -&gt; T</code><a class="headerlink" href="#executefunc-callable-t-t" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Execute a function with retry logic</p>
<p><strong>Algorithm</strong>:
1. Create <code>Retrying</code> instance from tenacity library
2. Configure stop condition: <code>stop_after_attempt(max_attempts)</code>
3. Configure wait strategy: exponential backoff with <code>wait_exponential()</code>
4. Configure retry condition: <code>retry_if_exception_type(retryable_exceptions)</code>
5. Execute function through retryer
6. If all retries fail, reraise last exception</p>
<p><strong>Parameters</strong>:
- <code>func: Callable[[], T]</code> - Zero-argument function to execute</p>
<p><strong>Returns</strong>: <code>T</code> - Result from successful function execution</p>
<p><strong>Raises</strong>: Last exception if all retries exhausted</p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">retry_handler</span> <span class="o">=</span> <span class="n">RetryHandler</span><span class="p">(</span><span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">initial_delay</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">risky_operation</span><span class="p">():</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="c1"># Might fail with RateLimitError</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="k">return</span> <span class="n">call_llm_api</span><span class="p">()</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="n">result</span> <span class="o">=</span> <span class="n">retry_handler</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">risky_operation</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Design Decision</strong>: Use tenacity library instead of custom implementation
- <strong>Why</strong>: tenacity is battle-tested, handles edge cases, provides flexible configuration
- <strong>Alternative</strong>: Custom retry loop (simpler but less robust)
- <strong>Trade-off</strong>: Additional dependency vs. reliability</p>
<h5 id="calculate_delayattempt-int-float"><code>calculate_delay(attempt: int) -&gt; float</code><a class="headerlink" href="#calculate_delayattempt-int-float" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Calculate delay for given attempt number (for informational/testing purposes)</p>
<p><strong>Algorithm</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">delay</span> <span class="o">=</span> <span class="n">initial_delay</span> <span class="o">*</span> <span class="p">(</span><span class="n">exponential_base</span> <span class="o">**</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">max_delay</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Parameters</strong>:
- <code>attempt: int</code> - Attempt number (1-based)</p>
<p><strong>Returns</strong>: <code>float</code> - Delay in seconds</p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">handler</span> <span class="o">=</span> <span class="n">RetryHandler</span><span class="p">(</span><span class="n">initial_delay</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">exponential_base</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_delay</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">handler</span><span class="o">.</span><span class="n">calculate_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 1.0 second</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">handler</span><span class="o">.</span><span class="n">calculate_delay</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 2.0 seconds</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="n">handler</span><span class="o">.</span><span class="n">calculate_delay</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 4.0 seconds</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="n">handler</span><span class="o">.</span><span class="n">calculate_delay</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># 8.0 seconds</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">handler</span><span class="o">.</span><span class="n">calculate_delay</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># 60.0 seconds (capped at max_delay)</span>
</span></code></pre></div></p>
<h3 id="thread-safety">Thread Safety<a class="headerlink" href="#thread-safety" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Thread-safe</strong>: Yes (stateless operation, no shared mutable state)</li>
<li>Each <code>execute()</code> call is independent</li>
<li>tenacity handles thread safety internally</li>
</ul>
<h3 id="dependencies_1">Dependencies<a class="headerlink" href="#dependencies_1" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>                  <span class="c1"># For delays</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>  <span class="c1"># Type hints</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tenacity</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>       <span class="c1"># Retry library</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="n">Retrying</span><span class="p">,</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    <span class="n">retry_if_exception_type</span><span class="p">,</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="n">stop_after_attempt</span><span class="p">,</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="n">wait_exponential</span><span class="p">,</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="p">)</span>
</span></code></pre></div>
<h3 id="used-by_1">Used By<a class="headerlink" href="#used-by_1" title="Permanent link">&para;</a></h3>
<ul>
<li><code>LLMInvocationStage</code> - Retries LLM API calls</li>
<li>Any component needing retry logic</li>
</ul>
<h3 id="design-patterns">Design Patterns<a class="headerlink" href="#design-patterns" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Strategy Pattern</strong>: Configurable retry strategy via parameters</li>
<li><strong>Dependency Inversion</strong>: Uses abstract <code>Callable</code> type, not specific implementations</li>
</ol>
<h3 id="time-complexity">Time Complexity<a class="headerlink" href="#time-complexity" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Exponential backoff</strong>: O(2^n) time in worst case (where n = max_attempts)</li>
<li>Actual delays: 1s, 2s, 4s, 8s, 16s, ...</li>
</ul>
<h3 id="testing-considerations">Testing Considerations<a class="headerlink" href="#testing-considerations" title="Permanent link">&para;</a></h3>
<ul>
<li>Test with mocked functions that fail predictably</li>
<li>Verify exponential backoff timing</li>
<li>Test max_attempts enforcement</li>
<li>Test exception filtering (retryable vs. non-retryable)</li>
</ul>
<h3 id="known-limitations_1">Known Limitations<a class="headerlink" href="#known-limitations_1" title="Permanent link">&para;</a></h3>
<ul>
<li>No jitter (could add randomness to prevent thundering herd)</li>
<li>Fixed exponential formula (could support other backoff strategies)</li>
</ul>
<h3 id="future-improvements_1">Future Improvements<a class="headerlink" href="#future-improvements_1" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Add jitter support for distributed systems</li>
<li>[ ] Support custom backoff strategies (linear, polynomial)</li>
<li>[ ] Add metrics for retry count tracking</li>
</ul>
<hr />
<h2 id="33-utilsrate_limiterpy">3.3 <code>utils/rate_limiter.py</code><a class="headerlink" href="#33-utilsrate_limiterpy" title="Permanent link">&para;</a></h2>
<h3 id="purpose_2">Purpose<a class="headerlink" href="#purpose_2" title="Permanent link">&para;</a></h3>
<p>Implements token bucket algorithm for rate limiting API calls.</p>
<h3 id="classes_1">Classes<a class="headerlink" href="#classes_1" title="Permanent link">&para;</a></h3>
<h4 id="ratelimiter-class"><code>RateLimiter</code> (Class)<a class="headerlink" href="#ratelimiter-class" title="Permanent link">&para;</a></h4>
<p><strong>Responsibility</strong>: Control request rate using token bucket algorithm</p>
<p><strong>Algorithm</strong>: Token Bucket
- Bucket has maximum capacity (burst_size)
- Tokens refill at constant rate (requests_per_minute / 60)
- Each request consumes tokens
- If no tokens available, wait until refilled</p>
<p><strong>Thread Safety</strong>: <strong>Thread-safe</strong> via <code>threading.Lock</code></p>
<p><strong>Attributes</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">rpm</span><span class="p">:</span> <span class="nb">int</span>                    <span class="c1"># Requests per minute limit</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span>               <span class="c1"># Maximum burst size</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="n">tokens</span><span class="p">:</span> <span class="nb">float</span>               <span class="c1"># Current available tokens</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="n">last_update</span><span class="p">:</span> <span class="nb">float</span>          <span class="c1"># Last refill timestamp</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="n">lock</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span>        <span class="c1"># Thread safety</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="n">refill_rate</span><span class="p">:</span> <span class="nb">float</span>          <span class="c1"># Tokens per second</span>
</span></code></pre></div></p>
<p><strong>Methods</strong>:</p>
<h5 id="__init__requests_per_minute-int-burst_size-optionalint-none"><code>__init__(requests_per_minute: int, burst_size: Optional[int] = None)</code><a class="headerlink" href="#__init__requests_per_minute-int-burst_size-optionalint-none" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Initialize rate limiter with capacity and refill rate</p>
<p><strong>Parameters</strong>:
- <code>requests_per_minute: int</code> - Maximum requests allowed per minute
- <code>burst_size: Optional[int] = None</code> - Maximum burst size (defaults to <code>requests_per_minute</code>)</p>
<p><strong>Design Decision</strong>: Separate burst_size from requests_per_minute
- <strong>Why</strong>: Allow bursts up to capacity, then throttle to sustained rate
- <strong>Example</strong>: <code>rpm=60, burst=120</code> allows 120 immediate requests, then throttles to 1/second</p>
<p><strong>Initialization</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">rpm</span> <span class="o">=</span> <span class="n">requests_per_minute</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">burst_size</span> <span class="ow">or</span> <span class="n">requests_per_minute</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">)</span>  <span class="c1"># Start with full capacity</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span> <span class="o">=</span> <span class="n">requests_per_minute</span> <span class="o">/</span> <span class="mf">60.0</span>  <span class="c1"># Tokens per second</span>
</span></code></pre></div></p>
<h5 id="acquiretokens-int-1-timeout-optionalfloat-none-bool"><code>acquire(tokens: int = 1, timeout: Optional[float] = None) -&gt; bool</code><a class="headerlink" href="#acquiretokens-int-1-timeout-optionalfloat-none-bool" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Acquire tokens for making requests (blocks until available)</p>
<p><strong>Algorithm</strong>:
1. Check if requested tokens &lt;= capacity (raise ValueError if not)
2. Loop:
   a. Acquire lock
   b. Refill tokens based on elapsed time
   c. If sufficient tokens available:
      - Deduct tokens
      - Return True
   d. Release lock
   e. Check timeout
   f. Sleep briefly (0.1s) before retry</p>
<p><strong>Parameters</strong>:
- <code>tokens: int = 1</code> - Number of tokens to acquire
- <code>timeout: Optional[float] = None</code> - Maximum wait time (None = wait forever)</p>
<p><strong>Returns</strong>: <code>bool</code>
- <code>True</code> if tokens acquired
- <code>False</code> if timeout reached</p>
<p><strong>Raises</strong>: <code>ValueError</code> if <code>tokens &gt; capacity</code></p>
<p><strong>Thread Safety</strong>: Lock protects token bucket state during check-and-decrement</p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">requests_per_minute</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">burst_size</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="c1"># Acquire 1 token (default)</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="k">if</span> <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">():</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>    <span class="n">make_api_call</span><span class="p">()</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="c1"># Acquire with timeout</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="k">if</span> <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">tokens</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>    <span class="n">make_api_call</span><span class="p">()</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for rate limit&quot;</span><span class="p">)</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="c1"># Acquire multiple tokens</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="k">if</span> <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">tokens</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>    <span class="n">make_batch_api_call</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></code></pre></div></p>
<h5 id="_refill-none"><code>_refill() -&gt; None</code><a class="headerlink" href="#_refill-none" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Refill tokens based on elapsed time (internal method)</p>
<p><strong>Algorithm</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">elapsed</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="n">tokens_to_add</span> <span class="o">=</span> <span class="n">elapsed</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">refill_rate</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">+</span> <span class="n">tokens_to_add</span><span class="p">)</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">now</span>
</span></code></pre></div></p>
<p><strong>Design Decision</strong>: Continuous refill vs. discrete intervals
- <strong>Chosen</strong>: Continuous refill (calculate tokens based on elapsed time)
- <strong>Why</strong>: More accurate, smoother rate limiting
- <strong>Alternative</strong>: Refill in discrete chunks (simpler but less accurate)</p>
<p><strong>Thread Safety</strong>: Called only while holding lock</p>
<h5 id="available_tokens-property"><code>available_tokens</code> (Property)<a class="headerlink" href="#available_tokens-property" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Get current available tokens (thread-safe)</p>
<p><strong>Returns</strong>: <code>float</code> - Current token count</p>
<p><strong>Thread Safety</strong>: Acquires lock, refills, returns tokens</p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">requests_per_minute</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="n">limiter</span><span class="o">.</span><span class="n">available_tokens</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># e.g., 45.3</span>
</span></code></pre></div></p>
<h5 id="reset-none"><code>reset() -&gt; None</code><a class="headerlink" href="#reset-none" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Reset rate limiter to full capacity</p>
<p><strong>Thread Safety</strong>: Acquires lock, resets tokens and timestamp</p>
<p><strong>Use Case</strong>: Manual reset after known idle period</p>
<h3 id="token-bucket-algorithm">Token Bucket Algorithm<a class="headerlink" href="#token-bucket-algorithm" title="Permanent link">&para;</a></h3>
<p><strong>Visual</strong>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>Bucket (capacity = 100)
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>       Current: 80 tokens
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>               Refill rate: 60/minute = 1/second
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>After 5 seconds:
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>    Current: 85 tokens (80 + 5*1)
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>After acquire(10):
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>       Current: 75 tokens
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>
</span></code></pre></div></p>
<p><strong>Properties</strong>:
- Allows bursts up to capacity
- Refills continuously at constant rate
- Smooth rate limiting (no hard boundaries)</p>
<h3 id="dependencies_2">Dependencies<a class="headerlink" href="#dependencies_2" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>          <span class="c1"># Lock for thread safety</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>              <span class="c1"># Timestamp tracking</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span></code></pre></div>
<h3 id="used-by_2">Used By<a class="headerlink" href="#used-by_2" title="Permanent link">&para;</a></h3>
<ul>
<li><code>LLMInvocationStage</code> - Rate limit API calls</li>
<li>Any component needing request throttling</li>
</ul>
<h3 id="thread-safety-details">Thread Safety Details<a class="headerlink" href="#thread-safety-details" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>  <span class="c1"># Critical section</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_refill</span><span class="p">()</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">&gt;=</span> <span class="n">tokens</span><span class="p">:</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">-=</span> <span class="n">tokens</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>        <span class="k">return</span> <span class="kc">True</span>
</span></code></pre></div>
<p><strong>Race Condition Prevention</strong>:
- Without lock: Two threads could both see sufficient tokens, both decrement, exceed capacity
- With lock: Only one thread can check-and-decrement at a time</p>
<h3 id="performance">Performance<a class="headerlink" href="#performance" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Time Complexity</strong>: O(1) per acquire</li>
<li><strong>Space Complexity</strong>: O(1) - constant space</li>
<li><strong>Lock Contention</strong>: Low (critical section is very short)</li>
</ul>
<h3 id="configuration-examples">Configuration Examples<a class="headerlink" href="#configuration-examples" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># Conservative (prevent rate limits)</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="n">limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">requests_per_minute</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">burst_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="c1"># Aggressive (maximize throughput)</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="n">limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">requests_per_minute</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">burst_size</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="c1"># Bursty workload (allow initial burst, then throttle)</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="n">limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">requests_per_minute</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">burst_size</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_rate_limiter</span><span class="p">():</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>    <span class="n">limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">requests_per_minute</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="c1"># Should acquire immediately</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>    <span class="k">assert</span> <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="c1"># Deplete tokens</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">59</span><span class="p">):</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>        <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>    <span class="c1"># Should timeout (no tokens left)</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>    <span class="c1"># Wait for refill</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>    <span class="k">assert</span> <span class="n">limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>  <span class="c1"># Should have ~2 tokens refilled</span>
</span></code></pre></div>
<h3 id="known-limitations_2">Known Limitations<a class="headerlink" href="#known-limitations_2" title="Permanent link">&para;</a></h3>
<ul>
<li>No distributed rate limiting (single-process only)</li>
<li>Fixed refill rate (can't adjust dynamically)</li>
<li>Polling-based waiting (could use condition variables)</li>
</ul>
<h3 id="future-improvements_2">Future Improvements<a class="headerlink" href="#future-improvements_2" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Add distributed rate limiting (Redis-based)</li>
<li>[ ] Support dynamic rate adjustment</li>
<li>[ ] Use condition variables instead of polling</li>
<li>[ ] Add metrics for rate limit hits</li>
</ul>
<hr />
<h2 id="34-utilscost_trackerpy">3.4 <code>utils/cost_tracker.py</code><a class="headerlink" href="#34-utilscost_trackerpy" title="Permanent link">&para;</a></h2>
<h3 id="purpose_3">Purpose<a class="headerlink" href="#purpose_3" title="Permanent link">&para;</a></h3>
<p>Thread-safe cost tracking for LLM API usage with detailed breakdowns.</p>
<h3 id="classes_2">Classes<a class="headerlink" href="#classes_2" title="Permanent link">&para;</a></h3>
<h4 id="costentry-dataclass"><code>CostEntry</code> (Dataclass)<a class="headerlink" href="#costentry-dataclass" title="Permanent link">&para;</a></h4>
<p><strong>Purpose</strong>: Single cost tracking entry</p>
<p><strong>Attributes</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">tokens_in</span><span class="p">:</span> <span class="nb">int</span>      <span class="c1"># Input tokens consumed</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">tokens_out</span><span class="p">:</span> <span class="nb">int</span>     <span class="c1"># Output tokens generated</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">cost</span><span class="p">:</span> <span class="n">Decimal</span>       <span class="c1"># Cost for this entry</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="n">model</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># Model identifier</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span>    <span class="c1"># When request occurred</span>
</span></code></pre></div></p>
<p><strong>Design Decision</strong>: Use dataclass for simplicity and immutability</p>
<h4 id="costtracker-class"><code>CostTracker</code> (Class)<a class="headerlink" href="#costtracker-class" title="Permanent link">&para;</a></h4>
<p><strong>Responsibility</strong>: Accumulate and track costs across LLM calls</p>
<p><strong>Single Responsibility</strong>: ONLY handles cost accounting, not enforcement (that's BudgetController's job)</p>
<p><strong>Thread Safety</strong>: <strong>Thread-safe</strong> via <code>threading.Lock</code></p>
<p><strong>Attributes</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">input_cost_per_1k</span><span class="p">:</span> <span class="n">Decimal</span>       <span class="c1"># Input token price per 1K tokens</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="n">output_cost_per_1k</span><span class="p">:</span> <span class="n">Decimal</span>      <span class="c1"># Output token price per 1K tokens</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="n">_total_input_tokens</span><span class="p">:</span> <span class="nb">int</span>         <span class="c1"># Cumulative input tokens</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="n">_total_output_tokens</span><span class="p">:</span> <span class="nb">int</span>        <span class="c1"># Cumulative output tokens</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="n">_total_cost</span><span class="p">:</span> <span class="n">Decimal</span>             <span class="c1"># Cumulative cost (Decimal for precision)</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="n">_entries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CostEntry</span><span class="p">]</span>        <span class="c1"># Detailed entry log</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="n">_stage_costs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]</span> <span class="c1"># Cost breakdown by stage</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="n">_lock</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span>            <span class="c1"># Thread safety</span>
</span></code></pre></div></p>
<p><strong>Design Decision</strong>: Use <code>Decimal</code> for cost (not <code>float</code>)
- <strong>Why</strong>: Avoid floating-point precision errors (<code>0.1 + 0.2 != 0.3</code>)
- <strong>Critical</strong>: Financial calculations must be exact
- <strong>Trade-off</strong>: Slightly slower than float, but necessary for accuracy</p>
<p><strong>Methods</strong>:</p>
<h5 id="__init__input_cost_per_1k-output_cost_per_1k"><code>__init__(input_cost_per_1k, output_cost_per_1k)</code><a class="headerlink" href="#__init__input_cost_per_1k-output_cost_per_1k" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Initialize cost tracker with pricing</p>
<p><strong>Parameters</strong>:
- <code>input_cost_per_1k: Optional[Decimal] = None</code> - Price per 1K input tokens
- <code>output_cost_per_1k: Optional[Decimal] = None</code> - Price per 1K output tokens</p>
<p><strong>Default</strong>: Both default to <code>Decimal("0.0")</code> if not provided</p>
<p><strong>Initialization</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">input_cost_per_1k</span> <span class="o">=</span> <span class="n">input_cost_per_1k</span> <span class="ow">or</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0&quot;</span><span class="p">)</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="bp">self</span><span class="o">.</span><span class="n">output_cost_per_1k</span> <span class="o">=</span> <span class="n">output_cost_per_1k</span> <span class="ow">or</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0&quot;</span><span class="p">)</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="bp">self</span><span class="o">.</span><span class="n">_total_input_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="bp">self</span><span class="o">.</span><span class="n">_total_output_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="bp">self</span><span class="o">.</span><span class="n">_total_cost</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0&quot;</span><span class="p">)</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="bp">self</span><span class="o">.</span><span class="n">_entries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="bp">self</span><span class="o">.</span><span class="n">_stage_costs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span></code></pre></div></p>
<h5 id="addtokens_in-tokens_out-model-timestamp-stage-decimal"><code>add(tokens_in, tokens_out, model, timestamp, stage) -&gt; Decimal</code><a class="headerlink" href="#addtokens_in-tokens_out-model-timestamp-stage-decimal" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Add cost entry and return cost for this operation</p>
<p><strong>Algorithm</strong>:
1. Calculate cost: <code>(tokens_in/1000) * input_price + (tokens_out/1000) * output_price</code>
2. Acquire lock
3. Create <code>CostEntry</code> and append to <code>_entries</code>
4. Accumulate tokens and cost
5. Update stage-specific costs
6. Release lock
7. Return calculated cost</p>
<p><strong>Parameters</strong>:
- <code>tokens_in: int</code> - Input tokens used
- <code>tokens_out: int</code> - Output tokens generated
- <code>model: str</code> - Model identifier
- <code>timestamp: float</code> - Request timestamp
- <code>stage: Optional[str] = None</code> - Stage name for breakdown</p>
<p><strong>Returns</strong>: <code>Decimal</code> - Cost for this entry</p>
<p><strong>Thread Safety</strong>: Entire operation protected by lock to ensure atomic update</p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">tracker</span> <span class="o">=</span> <span class="n">CostTracker</span><span class="p">(</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>    <span class="n">input_cost_per_1k</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00005&quot;</span><span class="p">),</span>  <span class="c1"># $0.05 per 1M input tokens</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>    <span class="n">output_cost_per_1k</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00008&quot;</span><span class="p">),</span>  <span class="c1"># $0.08 per 1M output tokens</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="p">)</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="n">cost</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>    <span class="n">tokens_in</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>    <span class="n">tokens_out</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>    <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>    <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;llm_invocation&quot;</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="p">)</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="c1"># cost = (1000/1000 * 0.00005) + (500/1000 * 0.00008)</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="c1">#      = 0.00005 + 0.00004</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="c1">#      = 0.00009 ($0.00009)</span>
</span></code></pre></div></p>
<h5 id="calculate_costtokens_in-tokens_out-decimal"><code>calculate_cost(tokens_in, tokens_out) -&gt; Decimal</code><a class="headerlink" href="#calculate_costtokens_in-tokens_out-decimal" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Calculate cost for given token counts (without recording)</p>
<p><strong>Algorithm</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">input_cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="n">tokens_in</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_cost_per_1k</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="n">output_cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="n">tokens_out</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_cost_per_1k</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="k">return</span> <span class="n">input_cost</span> <span class="o">+</span> <span class="n">output_cost</span>
</span></code></pre></div></p>
<p><strong>Use Case</strong>: Estimate cost before making request</p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">estimated</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span><span class="n">tokens_in</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">tokens_out</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="k">if</span> <span class="n">estimated</span> <span class="o">&gt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.01&quot;</span><span class="p">):</span>  <span class="c1"># More than 1 cent</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expensive request!&quot;</span><span class="p">)</span>
</span></code></pre></div></p>
<h5 id="total_cost-property"><code>total_cost</code> (Property)<a class="headerlink" href="#total_cost-property" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Get total accumulated cost (thread-safe)</p>
<p><strong>Returns</strong>: <code>Decimal</code> - Total cost</p>
<p><strong>Thread Safety</strong>: Acquires lock, reads <code>_total_cost</code>, releases lock</p>
<h5 id="total_tokens-input_tokens-output_tokens-properties"><code>total_tokens</code>, <code>input_tokens</code>, <code>output_tokens</code> (Properties)<a class="headerlink" href="#total_tokens-input_tokens-output_tokens-properties" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Get token counts (thread-safe)</p>
<p><strong>Returns</strong>: <code>int</code> - Token count</p>
<h5 id="get_estimaterows-costestimate"><code>get_estimate(rows) -&gt; CostEstimate</code><a class="headerlink" href="#get_estimaterows-costestimate" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Create cost estimate object from current tracking</p>
<p><strong>Returns</strong>: <code>CostEstimate</code> model with:
- <code>total_cost</code>
- <code>total_tokens</code>
- <code>input_tokens</code>
- <code>output_tokens</code>
- <code>rows</code> - Number of rows processed
- <code>breakdown_by_stage</code> - Dict of stage costs
- <code>confidence="actual"</code> - These are actual costs, not estimates</p>
<h5 id="reset-none_1"><code>reset() -&gt; None</code><a class="headerlink" href="#reset-none_1" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Clear all tracking data (thread-safe)</p>
<p><strong>Use Case</strong>: Reset between test runs or pipeline executions</p>
<h5 id="get_stage_costs-dictstr-decimal"><code>get_stage_costs() -&gt; Dict[str, Decimal]</code><a class="headerlink" href="#get_stage_costs-dictstr-decimal" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Get cost breakdown by stage</p>
<p><strong>Returns</strong>: Dictionary mapping stage names to costs</p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">stage_costs</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_stage_costs</span><span class="p">()</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="c1"># {&quot;llm_invocation&quot;: Decimal(&quot;0.15&quot;), &quot;retry&quot;: Decimal(&quot;0.02&quot;)}</span>
</span></code></pre></div></p>
<h3 id="dependencies_3">Dependencies<a class="headerlink" href="#dependencies_3" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>                      <span class="c1"># Thread safety</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>     <span class="c1"># CostEntry</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>           <span class="c1"># Precise financial calculations</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.core.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">CostEstimate</span>  <span class="c1"># Result model</span>
</span></code></pre></div>
<h3 id="used-by_3">Used By<a class="headerlink" href="#used-by_3" title="Permanent link">&para;</a></h3>
<ul>
<li><code>LLMInvocationStage</code> - Track costs during execution</li>
<li><code>PipelineExecutor</code> - Get total costs for result</li>
<li><code>BudgetController</code> - Check against budget limits</li>
</ul>
<h3 id="thread-safety-example">Thread Safety Example<a class="headerlink" href="#thread-safety-example" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1"># Two threads executing concurrently:</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="c1"># Thread 1: tracker.add(tokens_in=1000, tokens_out=500, ...)</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="c1"># Thread 2: tracker.add(tokens_in=800, tokens_out=300, ...)</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="c1"># Without lock: Race condition</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="c1"># 1. T1 reads _total_cost: 0.00</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="c1"># 2. T2 reads _total_cost: 0.00</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="c1"># 3. T1 writes _total_cost: 0.10</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="c1"># 4. T2 writes _total_cost: 0.08  # LOST UPDATE! T1&#39;s cost is lost</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="c1"># Final: 0.08 (WRONG, should be 0.18)</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="c1"># With lock: Correct</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="c1"># 1. T1 acquires lock</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="c1"># 2. T1 reads _total_cost: 0.00, calculates 0.10, writes 0.10</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="c1"># 3. T1 releases lock</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="c1"># 4. T2 acquires lock</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="c1"># 5. T2 reads _total_cost: 0.10, calculates 0.08, writes 0.18</span>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="c1"># 6. T2 releases lock</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="c1"># Final: 0.18 (CORRECT)</span>
</span></code></pre></div>
<h3 id="decimal-precision-example">Decimal Precision Example<a class="headerlink" href="#decimal-precision-example" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1"># Why Decimal is necessary:</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="c1"># Float (WRONG):</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="n">float_cost</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.2</span>  <span class="c1"># 0.30000000000000004 (WRONG!)</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="c1"># Decimal (CORRECT):</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="n">decimal_cost</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.1&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.2&quot;</span><span class="p">)</span>  <span class="c1"># 0.3 (CORRECT!)</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="c1"># Real-world impact:</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="c1"># If processing 1,000,000 rows with $0.0001 per row:</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="c1"># Float: $100.00000000014 (accumulated error)</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a><span class="c1"># Decimal: $100.00 (exact)</span>
</span></code></pre></div>
<h3 id="testing_1">Testing<a class="headerlink" href="#testing_1" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_cost_tracker</span><span class="p">():</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>    <span class="n">tracker</span> <span class="o">=</span> <span class="n">CostTracker</span><span class="p">(</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>        <span class="n">input_cost_per_1k</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00005&quot;</span><span class="p">),</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>        <span class="n">output_cost_per_1k</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00008&quot;</span><span class="p">),</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>    <span class="p">)</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>    <span class="c1"># Add cost</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>    <span class="n">cost1</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tokens_in</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tokens_out</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>    <span class="k">assert</span> <span class="n">cost1</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00009&quot;</span><span class="p">)</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>    <span class="c1"># Check accumulation</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>    <span class="k">assert</span> <span class="n">tracker</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00009&quot;</span><span class="p">)</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>    <span class="k">assert</span> <span class="n">tracker</span><span class="o">.</span><span class="n">total_tokens</span> <span class="o">==</span> <span class="mi">1500</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a>    <span class="c1"># Add more</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a>    <span class="n">cost2</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tokens_in</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">tokens_out</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a>    <span class="k">assert</span> <span class="n">tracker</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00027&quot;</span><span class="p">)</span>  <span class="c1"># 0.00009 + 0.00018</span>
</span></code></pre></div>
<h3 id="known-limitations_3">Known Limitations<a class="headerlink" href="#known-limitations_3" title="Permanent link">&para;</a></h3>
<ul>
<li>Stores all entries in memory (could grow large for long runs)</li>
<li>No persistence (lost on crash)</li>
<li>No cost cap enforcement (that's BudgetController's job)</li>
</ul>
<h3 id="future-improvements_3">Future Improvements<a class="headerlink" href="#future-improvements_3" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Add entry pruning for long-running pipelines</li>
<li>[ ] Optional persistence to disk</li>
<li>[ ] Add cost forecasting based on trends</li>
<li>[ ] Support tiered pricing (cost changes with volume)</li>
</ul>
<hr />
<h2 id="35-utilsbudget_controllerpy">3.5 <code>utils/budget_controller.py</code><a class="headerlink" href="#35-utilsbudget_controllerpy" title="Permanent link">&para;</a></h2>
<h3 id="purpose_4">Purpose<a class="headerlink" href="#purpose_4" title="Permanent link">&para;</a></h3>
<p>Enforce budget limits and provide warnings during execution.</p>
<h3 id="classes_3">Classes<a class="headerlink" href="#classes_3" title="Permanent link">&para;</a></h3>
<h4 id="budgetexceedederror-exception"><code>BudgetExceededError</code> (Exception)<a class="headerlink" href="#budgetexceedederror-exception" title="Permanent link">&para;</a></h4>
<p><strong>Inheritance</strong>: <code>Exception</code></p>
<p><strong>Purpose</strong>: Raised when budget limit is exceeded</p>
<p><strong>Usage</strong>: Allows caller to catch and handle budget overruns</p>
<h4 id="_1"><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<p><code>BudgetController</code> (Class)</p>
<p><strong>Responsibility</strong>: Monitor costs and enforce budget limits</p>
<p><strong>Single Responsibility</strong>: ONLY handles budget management (cost tracking is CostTracker's job)</p>
<p><strong>Separation of Concerns</strong>:
- <code>CostTracker</code>: Accumulates costs
- <code>BudgetController</code>: Enforces limits</p>
<p><strong>Attributes</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">max_budget</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Decimal</span><span class="p">]</span>  <span class="c1"># Maximum allowed budget (None = no limit)</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="n">warn_at_75</span><span class="p">:</span> <span class="nb">bool</span>              <span class="c1"># Warn at 75% of budget</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="n">warn_at_90</span><span class="p">:</span> <span class="nb">bool</span>              <span class="c1"># Warn at 90% of budget</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="n">fail_on_exceed</span><span class="p">:</span> <span class="nb">bool</span>          <span class="c1"># Raise error if budget exceeded</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="n">_warned_75</span><span class="p">:</span> <span class="nb">bool</span>              <span class="c1"># Track if 75% warning already shown</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="n">_warned_90</span><span class="p">:</span> <span class="nb">bool</span>              <span class="c1"># Track if 90% warning already shown</span>
</span></code></pre></div></p>
<p><strong>Design Decision</strong>: Separate warning flags from budget
- <strong>Why</strong>: Show each warning only once
- <strong>Alternative</strong>: Check every time (would spam logs)</p>
<p><strong>Methods</strong>:</p>
<h5 id="__init__max_budget-warn_at_75-warn_at_90-fail_on_exceed"><code>__init__(max_budget, warn_at_75, warn_at_90, fail_on_exceed)</code><a class="headerlink" href="#__init__max_budget-warn_at_75-warn_at_90-fail_on_exceed" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Initialize budget controller with limits</p>
<p><strong>Parameters</strong>:
- <code>max_budget: Optional[Decimal] = None</code> - Maximum budget in USD
- <code>warn_at_75: bool = True</code> - Warn at 75% usage
- <code>warn_at_90: bool = True</code> - Warn at 90% usage
- <code>fail_on_exceed: bool = True</code> - Raise error when exceeded</p>
<p><strong>Default Behavior</strong>: Warn twice, then fail</p>
<p><strong>Flexible Configuration</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># Strict (default): Fail on exceed</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">controller</span> <span class="o">=</span> <span class="n">BudgetController</span><span class="p">(</span><span class="n">max_budget</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.0&quot;</span><span class="p">))</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="c1"># Warn only: Don&#39;t fail</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="n">controller</span> <span class="o">=</span> <span class="n">BudgetController</span><span class="p">(</span><span class="n">max_budget</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.0&quot;</span><span class="p">),</span> <span class="n">fail_on_exceed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="c1"># No warnings: Just hard limit</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="n">controller</span> <span class="o">=</span> <span class="n">BudgetController</span><span class="p">(</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>    <span class="n">max_budget</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.0&quot;</span><span class="p">),</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a>    <span class="n">warn_at_75</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a>    <span class="n">warn_at_90</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="p">)</span>
</span></code></pre></div></p>
<h5 id="check_budgetcurrent_cost-decimal-none"><code>check_budget(current_cost: Decimal) -&gt; None</code><a class="headerlink" href="#check_budgetcurrent_cost-decimal-none" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Check if cost is within budget, warn or fail as configured</p>
<p><strong>Algorithm</strong>:
1. If <code>max_budget</code> is None, return (no limit)
2. Calculate usage ratio: <code>current_cost / max_budget</code>
3. If &gt;= 0.75 and not warned: Log warning, set <code>_warned_75 = True</code>
4. If &gt;= 0.90 and not warned: Log warning, set <code>_warned_90 = True</code>
5. If &gt; <code>max_budget</code>:
   - Log error
   - If <code>fail_on_exceed</code>: raise <code>BudgetExceededError</code></p>
<p><strong>Parameters</strong>:
- <code>current_cost: Decimal</code> - Current accumulated cost</p>
<p><strong>Raises</strong>: <code>BudgetExceededError</code> if cost exceeds budget and <code>fail_on_exceed=True</code></p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">controller</span> <span class="o">=</span> <span class="n">BudgetController</span><span class="p">(</span><span class="n">max_budget</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.0&quot;</span><span class="p">))</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="c1"># Check after each operation</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="n">controller</span><span class="o">.</span><span class="n">check_budget</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5.0&quot;</span><span class="p">))</span>   <span class="c1"># OK</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="n">controller</span><span class="o">.</span><span class="n">check_budget</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;7.5&quot;</span><span class="p">))</span>   <span class="c1"># Logs: &quot;75% used&quot;</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="n">controller</span><span class="o">.</span><span class="n">check_budget</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;9.0&quot;</span><span class="p">))</span>   <span class="c1"># Logs: &quot;90% used&quot;</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="n">controller</span><span class="o">.</span><span class="n">check_budget</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.5&quot;</span><span class="p">))</span>  <span class="c1"># Raises BudgetExceededError</span>
</span></code></pre></div></p>
<p><strong>Design Decision</strong>: Warnings at 75% and 90%
- <strong>Why</strong>: Give user time to react before hitting limit
- <strong>75%</strong>: Early warning
- <strong>90%</strong>: Final warning before failure
- <strong>Alternative</strong>: More granular warnings (every 10%) would spam logs</p>
<h5 id="get_remainingcurrent_cost-decimal-optionaldecimal"><code>get_remaining(current_cost: Decimal) -&gt; Optional[Decimal]</code><a class="headerlink" href="#get_remainingcurrent_cost-decimal-optionaldecimal" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Calculate remaining budget</p>
<p><strong>Returns</strong>:
- <code>Decimal</code> - Remaining budget
- <code>None</code> if no budget limit set</p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">controller</span> <span class="o">=</span> <span class="n">BudgetController</span><span class="p">(</span><span class="n">max_budget</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.0&quot;</span><span class="p">))</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="n">remaining</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;7.5&quot;</span><span class="p">))</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="c1"># remaining = Decimal(&quot;2.5&quot;)</span>
</span></code></pre></div></p>
<h5 id="get_usage_percentagecurrent_cost-decimal-optionalfloat"><code>get_usage_percentage(current_cost: Decimal) -&gt; Optional[float]</code><a class="headerlink" href="#get_usage_percentagecurrent_cost-decimal-optionalfloat" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Calculate budget usage as percentage</p>
<p><strong>Returns</strong>:
- <code>float</code> - Usage percentage (0-100+)
- <code>None</code> if no budget limit set</p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">controller</span> <span class="o">=</span> <span class="n">BudgetController</span><span class="p">(</span><span class="n">max_budget</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.0&quot;</span><span class="p">))</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="n">pct</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">get_usage_percentage</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;7.5&quot;</span><span class="p">))</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="c1"># pct = 75.0</span>
</span></code></pre></div></p>
<h5 id="can_affordestimated_cost-decimal-current_cost-decimal-bool"><code>can_afford(estimated_cost: Decimal, current_cost: Decimal) -&gt; bool</code><a class="headerlink" href="#can_affordestimated_cost-decimal-current_cost-decimal-bool" title="Permanent link">&para;</a></h5>
<p><strong>Purpose</strong>: Check if estimated additional cost fits within budget</p>
<p><strong>Algorithm</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_budget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>    <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="k">return</span> <span class="p">(</span><span class="n">current_cost</span> <span class="o">+</span> <span class="n">estimated_cost</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_budget</span>
</span></code></pre></div></p>
<p><strong>Use Case</strong>: Pre-flight check before expensive operation</p>
<p><strong>Example</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">controller</span> <span class="o">=</span> <span class="n">BudgetController</span><span class="p">(</span><span class="n">max_budget</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.0&quot;</span><span class="p">))</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="n">current</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;9.0&quot;</span><span class="p">)</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="n">estimated_next</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.5&quot;</span><span class="p">)</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="k">if</span> <span class="n">controller</span><span class="o">.</span><span class="n">can_afford</span><span class="p">(</span><span class="n">estimated_next</span><span class="p">,</span> <span class="n">current</span><span class="p">):</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>    <span class="n">proceed_with_operation</span><span class="p">()</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Would exceed budget, skipping&quot;</span><span class="p">)</span>
</span></code></pre></div></p>
<h3 id="dependencies_4">Dependencies<a class="headerlink" href="#dependencies_4" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>       <span class="c1"># Precise financial calculations</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">structlog</span>                  <span class="c1"># Structured logging</span>
</span></code></pre></div>
<h3 id="used-by_4">Used By<a class="headerlink" href="#used-by_4" title="Permanent link">&para;</a></h3>
<ul>
<li><code>PipelineExecutor</code> - Check budget during execution</li>
<li>Any component needing cost enforcement</li>
</ul>
<h3 id="integration-with-costtracker">Integration with CostTracker<a class="headerlink" href="#integration-with-costtracker" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1"># Typical usage pattern:</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="n">cost_tracker</span> <span class="o">=</span> <span class="n">CostTracker</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="n">budget_controller</span> <span class="o">=</span> <span class="n">BudgetController</span><span class="p">(</span><span class="n">max_budget</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.0&quot;</span><span class="p">))</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>    <span class="c1"># Make LLM call</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>    <span class="c1"># Track cost</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>    <span class="n">cost</span> <span class="o">=</span> <span class="n">cost_tracker</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tokens_in</span><span class="o">=...</span><span class="p">,</span> <span class="n">tokens_out</span><span class="o">=...</span><span class="p">)</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>    <span class="c1"># Check budget</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>    <span class="n">budget_controller</span><span class="o">.</span><span class="n">check_budget</span><span class="p">(</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">total_cost</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="testing_2">Testing<a class="headerlink" href="#testing_2" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_budget_warnings</span><span class="p">():</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>    <span class="n">controller</span> <span class="o">=</span> <span class="n">BudgetController</span><span class="p">(</span><span class="n">max_budget</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.0&quot;</span><span class="p">))</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>    <span class="c1"># Should not warn</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>    <span class="n">controller</span><span class="o">.</span><span class="n">check_budget</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5.0&quot;</span><span class="p">))</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>    <span class="c1"># Should warn at 75%</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>    <span class="n">controller</span><span class="o">.</span><span class="n">check_budget</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;7.5&quot;</span><span class="p">))</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>    <span class="c1"># Should warn at 90%</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>    <span class="n">controller</span><span class="o">.</span><span class="n">check_budget</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;9.0&quot;</span><span class="p">))</span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>    <span class="c1"># Should raise error</span>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">BudgetExceededError</span><span class="p">):</span>
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a>        <span class="n">controller</span><span class="o">.</span><span class="n">check_budget</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.1&quot;</span><span class="p">))</span>
</span></code></pre></div>
<h3 id="error-messages">Error Messages<a class="headerlink" href="#error-messages" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1"># 75% warning:</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="s2">&quot;Budget warning: 75</span><span class="si">% u</span><span class="s2">sed ($7.50 / $10.00)&quot;</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="c1"># 90% warning:</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="s2">&quot;Budget warning: 90</span><span class="si">% u</span><span class="s2">sed ($9.00 / $10.00)&quot;</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="c1"># Budget exceeded:</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="s2">&quot;Budget exceeded: $10.50 &gt; $10.00&quot;</span>
</span></code></pre></div>
<h3 id="known-limitations_4">Known Limitations<a class="headerlink" href="#known-limitations_4" title="Permanent link">&para;</a></h3>
<ul>
<li>No budget rollover (each execution is independent)</li>
<li>No budget sharing across pipelines</li>
<li>Fixed warning thresholds (75%, 90%)</li>
</ul>
<h3 id="future-improvements_4">Future Improvements<a class="headerlink" href="#future-improvements_4" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Configurable warning thresholds</li>
<li>[ ] Support budget pools (shared across pipelines)</li>
<li>[ ] Budget rollover support</li>
<li>[ ] Budget forecasting (estimate when limit will be hit)</li>
</ul>
<hr />
<p><em>This is Part 1 of the Technical Reference. Continue reading for Layer 0 (remaining utils), Core Models, and all other layers...</em></p>
<hr />
<h1 id="part-5-layer-1-infrastructure-adapters-llm-providers_1">Part 5: Layer 1 - Infrastructure Adapters (LLM Providers)<a class="headerlink" href="#part-5-layer-1-infrastructure-adapters-llm-providers_1" title="Permanent link">&para;</a></h1>
<h2 id="51-llm-provider-overview_1">5.1 LLM Provider Overview<a class="headerlink" href="#51-llm-provider-overview_1" title="Permanent link">&para;</a></h2>
<p>Ondine supports multiple LLM providers through the <strong>Adapter pattern</strong>, allowing easy switching between providers without changing core logic.</p>
<h3 id="supported-providers_1">Supported Providers<a class="headerlink" href="#supported-providers_1" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Category</th>
<th>Platform</th>
<th>Cost</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>OpenAI</strong></td>
<td>Cloud API</td>
<td>All</td>
<td>$$</td>
<td>Production, high quality</td>
</tr>
<tr>
<td><strong>Azure OpenAI</strong></td>
<td>Cloud API</td>
<td>All</td>
<td>$$</td>
<td>Enterprise, compliance, <strong>Managed Identity support</strong></td>
</tr>
<tr>
<td><strong>Anthropic</strong></td>
<td>Cloud API</td>
<td>All</td>
<td>$$$</td>
<td>Claude models, long context</td>
</tr>
<tr>
<td><strong>Groq</strong></td>
<td>Cloud API</td>
<td>All</td>
<td>Free tier</td>
<td>Fast inference, development</td>
</tr>
<tr>
<td><strong>MLX</strong></td>
<td>Local</td>
<td>macOS (Apple Silicon)</td>
<td>Free</td>
<td>Privacy, offline, no costs</td>
</tr>
</tbody>
</table>
<h3 id="provider-selection-guide_1">Provider Selection Guide<a class="headerlink" href="#provider-selection-guide_1" title="Permanent link">&para;</a></h3>
<p><strong>Choose OpenAI if</strong>: Production quality, mature ecosystem, GPT-4
<strong>Choose Azure if</strong>: Enterprise compliance, private deployments
<strong>Choose Anthropic if</strong>: Claude models, 100K+ context
<strong>Choose Groq if</strong>: Fast inference, free tier, development
<strong>Choose MLX if</strong>: Apple Silicon Mac, privacy, free, offline capable</p>
<hr />
<h2 id="52-openai-compatible-provider-custom-apis_1">5.2 OpenAI-Compatible Provider (Custom APIs)<a class="headerlink" href="#52-openai-compatible-provider-custom-apis_1" title="Permanent link">&para;</a></h2>
<h3 id="purpose_5">Purpose<a class="headerlink" href="#purpose_5" title="Permanent link">&para;</a></h3>
<p>Enable integration with any LLM API that implements the OpenAI chat completions format.</p>
<h3 id="class-openaicompatibleclient_1">Class: <code>OpenAICompatibleClient</code><a class="headerlink" href="#class-openaicompatibleclient_1" title="Permanent link">&para;</a></h3>
<p><strong>Inheritance</strong>: <code>LLMClient</code> (Adapter pattern)</p>
<p><strong>Platform</strong>: All (platform-agnostic)</p>
<p><strong>Responsibility</strong>: Connect to custom OpenAI-compatible API endpoints</p>
<p><strong>Supports</strong>:
- <strong>Ollama</strong> (local LLM server)
- <strong>vLLM</strong> (self-hosted inference)
- <strong>Together.AI</strong> (cloud API)
- <strong>Anyscale</strong> (cloud API)
- <strong>LocalAI</strong> (self-hosted)
- <strong>Any custom OpenAI-compatible API</strong></p>
<h3 id="configuration_1">Configuration<a class="headerlink" href="#configuration_1" title="Permanent link">&para;</a></h3>
<p><strong>Required Fields</strong>:
- <code>provider: openai_compatible</code>
- <code>base_url</code>: Custom API endpoint URL
- <code>model</code>: Model identifier</p>
<p><strong>Optional Fields</strong>:
- <code>provider_name</code>: Custom name for logging/metrics
- <code>api_key</code>: Authentication (optional for local)
- <code>input_cost_per_1k_tokens</code>: Custom pricing
- <code>output_cost_per_1k_tokens</code>: Custom pricing</p>
<h3 id="design-decision-reuse-openai-client">Design Decision: Reuse OpenAI Client<a class="headerlink" href="#design-decision-reuse-openai-client" title="Permanent link">&para;</a></h3>
<p>Instead of reimplementing HTTP, leverage llama-index's OpenAI client:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>    <span class="n">model</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>    <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span> <span class="ow">or</span> <span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>    <span class="n">api_base</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span>  <span class="c1"># Custom URL</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="p">)</span>
</span></code></pre></div>
<p><strong>Rationale</strong>:
- DRY: Reuse well-tested code
- Reliability: Edge cases handled
- Compatibility: Ensures OpenAI format
- Maintainability: Benefit from upstream updates</p>
<h3 id="example-togetherai">Example: Together.AI<a class="headerlink" href="#example-togetherai" title="Permanent link">&para;</a></h3>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="nt">llm</span><span class="p">:</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openai_compatible</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="w">  </span><span class="nt">provider_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Together.AI&quot;</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">  </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">meta-llama/Llama-3.1-70B</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">  </span><span class="nt">base_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://api.together.xyz/v1</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">  </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">\${TOGETHER_API_KEY}</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">  </span><span class="nt">input_cost_per_1k_tokens</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0006</span>
</span></code></pre></div>
<h3 id="validation_1">Validation<a class="headerlink" href="#validation_1" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate_provider_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">OPENAI_COMPATIBLE</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">:</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;base_url required&quot;</span><span class="p">)</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>    <span class="k">return</span> <span class="bp">self</span>
</span></code></pre></div>
<hr />
<h2 id="53-azure-openai-provider-enterprise">5.3 Azure OpenAI Provider (Enterprise)<a class="headerlink" href="#53-azure-openai-provider-enterprise" title="Permanent link">&para;</a></h2>
<h3 id="purpose_6">Purpose<a class="headerlink" href="#purpose_6" title="Permanent link">&para;</a></h3>
<p>Enable enterprise-grade Azure OpenAI integration with support for both API key and Managed Identity authentication.</p>
<h3 id="class-azureopenaiclient">Class: <code>AzureOpenAIClient</code><a class="headerlink" href="#class-azureopenaiclient" title="Permanent link">&para;</a></h3>
<p><strong>Inheritance</strong>: <code>LLMClient</code> (Adapter pattern)</p>
<p><strong>Platform</strong>: All (cloud-based)</p>
<p><strong>Responsibility</strong>: Azure OpenAI Service integration with enterprise authentication</p>
<p><strong>Key Features</strong>:
- Managed Identity support (keyless authentication)
- API key authentication (backward compatible)
- Pre-fetched token support (advanced scenarios)
- Multi-region deployment support
- Azure RBAC integration</p>
<h3 id="authentication-methods">Authentication Methods<a class="headerlink" href="#authentication-methods" title="Permanent link">&para;</a></h3>
<p>Azure OpenAI supports three authentication methods (in priority order):</p>
<h4 id="1-managed-identity-recommended-for-production">1. Managed Identity (Recommended for Production)<a class="headerlink" href="#1-managed-identity-recommended-for-production" title="Permanent link">&para;</a></h4>
<p><strong>Purpose</strong>: Keyless authentication using Azure AD</p>
<p><strong>Requirements</strong>:
- <code>pip install ondine[azure]</code> (installs <code>azure-identity&gt;=1.15.0</code>)
- Managed Identity assigned to Azure resource
- RBAC role: "Cognitive Services OpenAI User"</p>
<p><strong>Configuration</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="o">.</span><span class="n">with_llm</span><span class="p">(</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>    <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;azure_openai&quot;</span><span class="p">,</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>    <span class="n">azure_endpoint</span><span class="o">=</span><span class="s2">&quot;https://your-resource.openai.azure.com/&quot;</span><span class="p">,</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>    <span class="n">azure_deployment</span><span class="o">=</span><span class="s2">&quot;gpt-4-deployment&quot;</span><span class="p">,</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>    <span class="n">use_managed_identity</span><span class="o">=</span><span class="kc">True</span>  <span class="c1">#  Keyless!</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>YAML Configuration</strong>:
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nt">llm</span><span class="p">:</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;azure_openai&quot;</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="w">  </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gpt-4&quot;</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">  </span><span class="nt">azure_endpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://your-resource.openai.azure.com/&quot;</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">  </span><span class="nt">azure_deployment</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gpt-4-deployment&quot;</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">  </span><span class="nt">use_managed_identity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># No API key needed!</span>
</span></code></pre></div></p>
<p><strong>How It Works</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">azure.identity</span><span class="w"> </span><span class="kn">import</span> <span class="n">DefaultAzureCredential</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="c1"># Ondine automatically:</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="n">credential</span> <span class="o">=</span> <span class="n">DefaultAzureCredential</span><span class="p">()</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="n">token</span> <span class="o">=</span> <span class="n">credential</span><span class="o">.</span><span class="n">get_token</span><span class="p">(</span><span class="s2">&quot;https://cognitiveservices.azure.com/.default&quot;</span><span class="p">)</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="c1"># Passes token to LlamaIndex</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">AzureOpenAI</span><span class="p">(</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>    <span class="n">azure_ad_token</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>  <span class="c1">#  Token, not API key</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>    <span class="n">azure_endpoint</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">azure_endpoint</span><span class="p">,</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a>    <span class="n">deployment_name</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">azure_deployment</span><span class="p">,</span>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>DefaultAzureCredential Resolution Order</strong>:
1. Environment variables (AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_CLIENT_SECRET)
2. Managed Identity (if running on Azure VM/Container/Function)
3. Azure CLI credentials (if <code>az login</code> executed)
4. Visual Studio Code credentials
5. Azure PowerShell credentials</p>
<p><strong>Benefits</strong>:
-  No API keys in code or environment
-  Automatic credential rotation (Azure AD handles it)
-  Fine-grained RBAC via Azure roles
-  Audit trail through Azure AD logs
-  Works across dev/staging/production</p>
<p><strong>Local Development</strong>:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># Login with Azure CLI</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>az<span class="w"> </span>login
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="c1"># Run your script (uses your Azure CLI credentials)</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>python<span class="w"> </span>your_script.py
</span></code></pre></div></p>
<p><strong>Production Deployment</strong>:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c1"># Assign Managed Identity to Azure resource</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>az<span class="w"> </span>vm<span class="w"> </span>identity<span class="w"> </span>assign<span class="w"> </span>--name<span class="w"> </span>my-vm<span class="w"> </span>--resource-group<span class="w"> </span>my-rg
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="c1"># Grant RBAC role</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a>az<span class="w"> </span>role<span class="w"> </span>assignment<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">  </span>--assignee<span class="w"> </span>&lt;managed-identity-id&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">  </span>--role<span class="w"> </span><span class="s2">&quot;Cognitive Services OpenAI User&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">  </span>--scope<span class="w"> </span>&lt;openai-resource-id&gt;
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="c1"># Run your script (uses Managed Identity automatically)</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>python<span class="w"> </span>your_script.py
</span></code></pre></div></p>
<h4 id="2-pre-fetched-azure-ad-token-advanced">2. Pre-fetched Azure AD Token (Advanced)<a class="headerlink" href="#2-pre-fetched-azure-ad-token-advanced" title="Permanent link">&para;</a></h4>
<p><strong>Purpose</strong>: Manual token management for custom scenarios</p>
<p><strong>Configuration</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">azure.identity</span><span class="w"> </span><span class="kn">import</span> <span class="n">DefaultAzureCredential</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="c1"># Fetch token manually</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="n">credential</span> <span class="o">=</span> <span class="n">DefaultAzureCredential</span><span class="p">()</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="n">token</span> <span class="o">=</span> <span class="n">credential</span><span class="o">.</span><span class="n">get_token</span><span class="p">(</span><span class="s2">&quot;https://cognitiveservices.azure.com/.default&quot;</span><span class="p">)</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="o">.</span><span class="n">with_llm</span><span class="p">(</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>    <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;azure_openai&quot;</span><span class="p">,</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>    <span class="n">azure_endpoint</span><span class="o">=</span><span class="s2">&quot;https://your-resource.openai.azure.com/&quot;</span><span class="p">,</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a>    <span class="n">azure_deployment</span><span class="o">=</span><span class="s2">&quot;gpt-4-deployment&quot;</span><span class="p">,</span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a>    <span class="n">azure_ad_token</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">token</span>  <span class="c1">#  Pre-fetched token</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Use Cases</strong>:
- Custom token lifecycle management
- Token caching strategies
- Integration with existing auth systems</p>
<h4 id="3-api-key-backward-compatible">3. API Key (Backward Compatible)<a class="headerlink" href="#3-api-key-backward-compatible" title="Permanent link">&para;</a></h4>
<p><strong>Purpose</strong>: Traditional authentication method</p>
<p><strong>Configuration</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="o">.</span><span class="n">with_llm</span><span class="p">(</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>    <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;azure_openai&quot;</span><span class="p">,</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>    <span class="n">azure_endpoint</span><span class="o">=</span><span class="s2">&quot;https://your-resource.openai.azure.com/&quot;</span><span class="p">,</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>    <span class="n">azure_deployment</span><span class="o">=</span><span class="s2">&quot;gpt-4-deployment&quot;</span><span class="p">,</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_OPENAI_API_KEY&quot;</span><span class="p">)</span>  <span class="c1">#  API key</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>YAML Configuration</strong>:
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="nt">llm</span><span class="p">:</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;azure_openai&quot;</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="w">  </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gpt-4&quot;</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="w">  </span><span class="nt">azure_endpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://your-resource.openai.azure.com/&quot;</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="w">  </span><span class="nt">azure_deployment</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gpt-4-deployment&quot;</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">  </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${AZURE_OPENAI_API_KEY}</span><span class="w">  </span><span class="c1"># From environment</span>
</span></code></pre></div></p>
<p><strong>Setup</strong>:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AZURE_OPENAI_API_KEY</span><span class="o">=</span><span class="s2">&quot;your-key-from-azure-portal&quot;</span><span class="w">  </span><span class="c1"># pragma: allowlist secret</span>
</span></code></pre></div></p>
<h3 id="architecture_1">Architecture<a class="headerlink" href="#architecture_1" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AzureOpenAIClient</span><span class="p">(</span><span class="n">LLMClient</span><span class="p">):</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">LLMSpec</span><span class="p">):</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>        <span class="c1"># Validate required fields</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">azure_endpoint</span><span class="p">:</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;azure_endpoint required&quot;</span><span class="p">)</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">azure_deployment</span><span class="p">:</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;azure_deployment required&quot;</span><span class="p">)</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>        <span class="c1"># Authentication priority:</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">use_managed_identity</span><span class="p">:</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>            <span class="c1"># 1. Managed Identity (preferred)</span>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a>            <span class="n">credential</span> <span class="o">=</span> <span class="n">DefaultAzureCredential</span><span class="p">()</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a>            <span class="n">token</span> <span class="o">=</span> <span class="n">credential</span><span class="o">.</span><span class="n">get_token</span><span class="p">(</span><span class="s2">&quot;https://cognitiveservices.azure.com/.default&quot;</span><span class="p">)</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">AzureOpenAI</span><span class="p">(</span><span class="n">azure_ad_token</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>        <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">azure_ad_token</span><span class="p">:</span>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a>            <span class="c1"># 2. Pre-fetched token</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">AzureOpenAI</span><span class="p">(</span><span class="n">azure_ad_token</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">azure_ad_token</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a>            <span class="c1"># 3. API key (backward compatible)</span>
</span><span id="__span-61-22"><a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a>            <span class="n">api_key</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_OPENAI_API_KEY&quot;</span><span class="p">)</span>
</span><span id="__span-61-23"><a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">AzureOpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="configuration-fields">Configuration Fields<a class="headerlink" href="#configuration-fields" title="Permanent link">&para;</a></h3>
<p><strong>Required</strong>:
- <code>provider: "azure_openai"</code>
- <code>azure_endpoint</code>: Azure OpenAI resource endpoint
- <code>azure_deployment</code>: Deployment name (maps to model)</p>
<p><strong>Authentication (choose one)</strong>:
- <code>use_managed_identity: bool</code> - Use Azure Managed Identity (recommended)
- <code>azure_ad_token: str</code> - Pre-fetched Azure AD token
- <code>api_key: str</code> - API key from Azure Portal</p>
<p><strong>Optional</strong>:
- <code>api_version: str</code> - API version (default: "2024-02-15-preview")
- <code>temperature: float</code> - Sampling temperature
- <code>max_tokens: int</code> - Maximum output tokens</p>
<h3 id="multi-region-support">Multi-Region Support<a class="headerlink" href="#multi-region-support" title="Permanent link">&para;</a></h3>
<p>Azure OpenAI is available in multiple regions for data residency and latency optimization:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c1"># Region-specific endpoints</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="n">regions</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>    <span class="s2">&quot;eastus&quot;</span><span class="p">:</span> <span class="s2">&quot;https://eastus-resource.openai.azure.com/&quot;</span><span class="p">,</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>    <span class="s2">&quot;westeurope&quot;</span><span class="p">:</span> <span class="s2">&quot;https://westeurope-resource.openai.azure.com/&quot;</span><span class="p">,</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>    <span class="s2">&quot;swedencentral&quot;</span><span class="p">:</span> <span class="s2">&quot;https://swedencentral-resource.openai.azure.com/&quot;</span><span class="p">,</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>    <span class="s2">&quot;japaneast&quot;</span><span class="p">:</span> <span class="s2">&quot;https://japaneast-resource.openai.azure.com/&quot;</span><span class="p">,</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="p">}</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="c1"># Environment-aware configuration</span>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="n">region</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_REGION&quot;</span><span class="p">,</span> <span class="s2">&quot;eastus&quot;</span><span class="p">)</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="n">endpoint</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="n">region</span><span class="p">]</span>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="o">.</span><span class="n">with_llm</span><span class="p">(</span>
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>    <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;azure_openai&quot;</span><span class="p">,</span>
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>    <span class="n">azure_endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span>
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a>    <span class="n">use_managed_identity</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-62-17"><a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a><span class="p">)</span>
</span></code></pre></div>
<h3 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h3>
<p><strong>Missing Dependency</strong>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>ImportError: Azure Managed Identity requires azure-identity.
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>Install with: pip install ondine[azure]
</span></code></pre></div></p>
<p><strong>Authentication Failure</strong>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>ValueError: Failed to authenticate with Azure Managed Identity: &lt;error&gt;.
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>Ensure the resource has a Managed Identity assigned with
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>&#39;Cognitive Services OpenAI User&#39; role.
</span></code></pre></div></p>
<p><strong>Missing Configuration</strong>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>ValueError: Azure OpenAI requires either:
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>  1. use_managed_identity=True (for keyless auth), or
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>  2. api_key parameter, or
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>  3. AZURE_OPENAI_API_KEY environment variable
</span></code></pre></div></p>
<h3 id="dependencies_5">Dependencies<a class="headerlink" href="#dependencies_5" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">llama_index.llms.azure_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">AzureOpenAI</span>  <span class="c1"># LlamaIndex wrapper</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">azure.identity</span><span class="w"> </span><span class="kn">import</span> <span class="n">DefaultAzureCredential</span>       <span class="c1"># Optional (for Managed Identity)</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tiktoken</span>                                         <span class="c1"># Token estimation</span>
</span></code></pre></div>
<h3 id="used-by_5">Used By<a class="headerlink" href="#used-by_5" title="Permanent link">&para;</a></h3>
<ul>
<li><code>create_llm_client()</code> factory</li>
<li>Any pipeline with <code>provider: azure_openai</code></li>
<li>Examples: <code>azure_managed_identity.py</code>, <code>azure_managed_identity_config.yaml</code></li>
</ul>
<h3 id="testing-strategy_1">Testing Strategy<a class="headerlink" href="#testing-strategy_1" title="Permanent link">&para;</a></h3>
<p><strong>Unit Tests (11 tests)</strong>:
- Managed Identity authentication flow
- Pre-fetched token authentication
- API key authentication (backward compatibility)
- Error handling (missing dependencies, failed authentication)
- Priority ordering (Managed Identity &gt; Token &gt; API Key)
- Missing configuration validation</p>
<p><strong>Integration Tests</strong>:
- Require actual Azure credentials (optional)
- Test real Azure AD authentication
- Verify RBAC permissions</p>
<h3 id="security-best-practices">Security Best Practices<a class="headerlink" href="#security-best-practices" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Production</strong>: Use Managed Identity (no secrets)</li>
<li><strong>Development</strong>: Use <code>az login</code> (personal credentials)</li>
<li><strong>CI/CD</strong>: Use Service Principal or Federated Identity</li>
<li><strong>Never</strong>: Hardcode API keys in source code</li>
</ol>
<h3 id="performance-characteristics_1">Performance Characteristics<a class="headerlink" href="#performance-characteristics_1" title="Permanent link">&para;</a></h3>
<p><strong>Managed Identity</strong>:
- Token fetch: ~100-200ms (first call)
- Token cached: ~1 hour (Azure AD default)
- Subsequent calls: No auth overhead</p>
<p><strong>API Key</strong>:
- No auth overhead (key is static)
- Manual rotation required</p>
<h3 id="known-limitations_5">Known Limitations<a class="headerlink" href="#known-limitations_5" title="Permanent link">&para;</a></h3>
<ul>
<li>Managed Identity only works on Azure infrastructure</li>
<li>Token refresh not automatic (pipeline must be restarted after 1 hour for long runs)</li>
<li>Cannot use Managed Identity with non-Azure OpenAI providers</li>
</ul>
<h3 id="future-improvements_5">Future Improvements<a class="headerlink" href="#future-improvements_5" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Automatic token refresh for long-running pipelines</li>
<li>[ ] Support for User-Assigned Managed Identity (currently uses DefaultAzureCredential)</li>
<li>[ ] Token caching across pipeline instances</li>
<li>[ ] Integration with Azure Key Vault for API key storage</li>
</ul>
<hr />
<h2 id="54-mlx-provider-apple-silicon">5.4 MLX Provider (Apple Silicon)<a class="headerlink" href="#54-mlx-provider-apple-silicon" title="Permanent link">&para;</a></h2>
<h3 id="purpose_7">Purpose<a class="headerlink" href="#purpose_7" title="Permanent link">&para;</a></h3>
<p>Enable fast, free, local LLM inference on Apple Silicon using Apple's MLX framework.</p>
<h3 id="class-mlxclient">Class: <code>MLXClient</code><a class="headerlink" href="#class-mlxclient" title="Permanent link">&para;</a></h3>
<p><strong>Inheritance</strong>: <code>LLMClient</code> (Adapter pattern)</p>
<p><strong>Platform</strong>: macOS with M1/M2/M3/M4 chips only</p>
<p><strong>Responsibility</strong>: Local in-process LLM inference using MLX framework</p>
<p><strong>Key Features</strong>:
- In-process (no server management)
- Model caching (load once, use many times)
- Lazy imports (only when MLX provider used)
- Dependency injection (clean testing)
- Free inference ($0 cost)</p>
<h3 id="architecture_2">Architecture<a class="headerlink" href="#architecture_2" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MLXClient</span><span class="p">(</span><span class="n">LLMClient</span><span class="p">):</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">LLMSpec</span><span class="p">,</span> <span class="n">_mlx_lm_module</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>        <span class="c1"># Lazy import with helpful error</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>        <span class="c1"># Load model once (cached in instance)</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMResponse</span><span class="p">:</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>        <span class="c1"># Use cached model for inference</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>        <span class="c1"># No server calls, all local</span>
</span></code></pre></div>
<p><strong>Design Decision: Dependency Injection</strong></p>
<p>The <code>_mlx_lm_module</code> parameter enables clean testing:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1"># Production usage (normal)</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="n">client</span> <span class="o">=</span> <span class="n">MLXClient</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>  <span class="c1"># Imports mlx_lm automatically</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="c1"># Testing usage (mocked)</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="n">mock_mlx</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="n">client</span> <span class="o">=</span> <span class="n">MLXClient</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">_mlx_lm_module</span><span class="o">=</span><span class="n">mock_mlx</span><span class="p">)</span>  <span class="c1"># Inject mock</span>
</span></code></pre></div>
<p><strong>Rationale</strong>:
- Testable: No sys.modules hacks
- Clear: Explicit what's being injected
- Backward compatible: Parameter is optional</p>
<h3 id="model-caching-strategy">Model Caching Strategy<a class="headerlink" href="#model-caching-strategy" title="Permanent link">&para;</a></h3>
<p><strong>Problem</strong>: Loading MLX models is expensive (~0.5-2 seconds)</p>
<p><strong>Solution</strong>: Load once in <code>__init__()</code>, cache in instance</p>
<p><strong>Impact</strong>:
- First invocation: ~0.7s (load) + ~0.7s (inference) = 1.4s
- Subsequent calls: ~0.7s (inference only)
- For 100 rows: Save ~70 seconds vs reload each time!</p>
<h3 id="token-estimation_1">Token Estimation<a class="headerlink" href="#token-estimation_1" title="Permanent link">&para;</a></h3>
<p><strong>Primary</strong>: Use MLX tokenizer (model-specific, accurate)
<div class="language-python highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="n">tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlx_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
</span></code></pre></div></p>
<p><strong>Fallback</strong>: Word count (if tokenizer fails)
<div class="language-python highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="n">tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span></code></pre></div></p>
<p><strong>Rationale</strong>: Graceful degradation, never fail on token estimation</p>
<h3 id="error-handling_1">Error Handling<a class="headerlink" href="#error-handling_1" title="Permanent link">&para;</a></h3>
<p><strong>Import Error</strong>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>ImportError: MLX not installed. Install with:
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>  pip install ondine[mlx]
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>or:
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>  pip install mlx mlx-lm
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>Note: MLX only works on Apple Silicon (M1/M2/M3/M4 chips)
</span></code></pre></div></p>
<p><strong>Model Load Error</strong>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>Exception: Failed to load MLX model &#39;model-name&#39;.
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>Ensure the model exists on HuggingFace and you have access.
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>Error: [original error]
</span></code></pre></div></p>
<p><strong>Design</strong>: Actionable error messages with context</p>
<h3 id="performance-characteristics_2">Performance Characteristics<a class="headerlink" href="#performance-characteristics_2" title="Permanent link">&para;</a></h3>
<p><strong>Tested on Apple Silicon (M2)</strong>:
- Model: <code>mlx-community/Qwen3-1.7B-4bit</code>
- Load time: 0.74s (once per pipeline)
- Inference: 0.67s/prompt
- Throughput: 1.49 prompts/sec
- Memory: ~2GB (model in RAM)</p>
<p><strong>Comparison</strong>:
- <strong>vs Cloud APIs</strong>: 10x faster (no network), free
- <strong>vs vLLM</strong>: Simpler (no server), Mac-compatible
- <strong>vs Ollama</strong>: Similar speed, more control</p>
<h3 id="thread-safety_1">Thread Safety<a class="headerlink" href="#thread-safety_1" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Not thread-safe</strong>: MLX models are not thread-safe</li>
<li><strong>Recommendation</strong>: Use <code>concurrency=1</code> in ProcessingSpec</li>
<li><strong>Why</strong>: MLX optimized for Apple Neural Engine (single-threaded)</li>
</ul>
<h3 id="dependencies_6">Dependencies<a class="headerlink" href="#dependencies_6" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">mlx_lm</span>  <span class="c1"># Lazy imported</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="c1"># mlx_lm depends on:</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="c1"># - mlx&gt;=0.29.0</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="c1"># - mlx-metal (GPU acceleration)</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="c1"># - transformers (HuggingFace)</span>
</span></code></pre></div>
<h3 id="used-by_6">Used By<a class="headerlink" href="#used-by_6" title="Permanent link">&para;</a></h3>
<ul>
<li><code>create_llm_client()</code> factory</li>
<li>Any pipeline with <code>provider: mlx</code></li>
<li>Examples: <code>10_mlx_qwen3_local.py</code>, <code>10_mlx_qwen3_local.yaml</code></li>
</ul>
<h3 id="testing-strategy_2">Testing Strategy<a class="headerlink" href="#testing-strategy_2" title="Permanent link">&para;</a></h3>
<p><strong>Dependency Injection Pattern</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1"># Create mock module</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="n">mock_mlx</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="n">mock_mlx</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">mock_model</span><span class="p">,</span> <span class="n">mock_tokenizer</span><span class="p">)</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="n">mock_mlx</span><span class="o">.</span><span class="n">generate</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;response&quot;</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="c1"># Inject for testing</span>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="n">client</span> <span class="o">=</span> <span class="n">MLXClient</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">_mlx_lm_module</span><span class="o">=</span><span class="n">mock_mlx</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Coverage</strong>:
- 14 unit tests
- Model loading/caching
- Token estimation with fallback
- Error handling
- Factory integration</p>
<h3 id="known-limitations_6">Known Limitations<a class="headerlink" href="#known-limitations_6" title="Permanent link">&para;</a></h3>
<ul>
<li>macOS only (MLX doesn't work on Linux/Windows)</li>
<li>Single-threaded (not optimized for concurrency)</li>
<li>Model download required (1-5GB per model)</li>
<li>Requires HuggingFace token for some models</li>
</ul>
<h3 id="future-improvements_6">Future Improvements<a class="headerlink" href="#future-improvements_6" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Add MLX streaming support</li>
<li>[ ] Support custom MLX generation parameters</li>
<li>[ ] Add model warmup option</li>
<li>[ ] Cache models globally (shared across pipelines)</li>
</ul>
<hr />
<h2 id="54-llm-provider-presets">5.4 LLM Provider Presets<a class="headerlink" href="#54-llm-provider-presets" title="Permanent link">&para;</a></h2>
<h3 id="purpose_8">Purpose<a class="headerlink" href="#purpose_8" title="Permanent link">&para;</a></h3>
<p>Simplify LLM provider configuration by providing pre-configured specifications for common providers, eliminating boilerplate and configuration errors.</p>
<h3 id="class-llmproviderpresets">Class: <code>LLMProviderPresets</code><a class="headerlink" href="#class-llmproviderpresets" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>ondine/core/specifications.py</code> (lines 301-453)</p>
<p><strong>Responsibility</strong>: Provide pre-validated LLMSpec instances for popular providers</p>
<p><strong>Design Pattern</strong>: Static Registry Pattern</p>
<p><strong>Key Features</strong>:
- Zero boilerplate for common providers (80% code reduction)
- Pre-validated configurations (correct URLs, pricing)
- No hardcoded API keys (security by design)
- IDE autocomplete support
- Pydantic validation throughout</p>
<h3 id="available-presets">Available Presets<a class="headerlink" href="#available-presets" title="Permanent link">&para;</a></h3>
<h4 id="openai-presets">OpenAI Presets<a class="headerlink" href="#openai-presets" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="n">GPT4O_MINI</span> <span class="o">=</span> <span class="n">LLMSpec</span><span class="p">(</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>    <span class="n">provider</span><span class="o">=</span><span class="n">LLMProvider</span><span class="o">.</span><span class="n">OPENAI</span><span class="p">,</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>    <span class="n">input_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00015&quot;</span><span class="p">),</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>    <span class="n">output_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0006&quot;</span><span class="p">),</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="p">)</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="n">GPT4O</span> <span class="o">=</span> <span class="n">LLMSpec</span><span class="p">(</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>    <span class="n">provider</span><span class="o">=</span><span class="n">LLMProvider</span><span class="o">.</span><span class="n">OPENAI</span><span class="p">,</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a>    <span class="n">input_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0025&quot;</span><span class="p">),</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>    <span class="n">output_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.01&quot;</span><span class="p">),</span>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a><span class="p">)</span>
</span></code></pre></div>
<h4 id="togetherai-presets">Together.AI Presets<a class="headerlink" href="#togetherai-presets" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="n">TOGETHER_AI_LLAMA_70B</span> <span class="o">=</span> <span class="n">LLMSpec</span><span class="p">(</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>    <span class="n">provider</span><span class="o">=</span><span class="n">LLMProvider</span><span class="o">.</span><span class="n">OPENAI_COMPATIBLE</span><span class="p">,</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>    <span class="n">provider_name</span><span class="o">=</span><span class="s2">&quot;Together.AI&quot;</span><span class="p">,</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;meta-llama/Meta-Llama-3.1-70B-Instruct-Turbo&quot;</span><span class="p">,</span>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.together.xyz/v1&quot;</span><span class="p">,</span>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>    <span class="n">input_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0006&quot;</span><span class="p">),</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a><span class="p">)</span>
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a><span class="n">TOGETHER_AI_LLAMA_8B</span> <span class="o">=</span> <span class="n">LLMSpec</span><span class="p">(</span>
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>    <span class="n">provider</span><span class="o">=</span><span class="n">LLMProvider</span><span class="o">.</span><span class="n">OPENAI_COMPATIBLE</span><span class="p">,</span>
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a>    <span class="n">provider_name</span><span class="o">=</span><span class="s2">&quot;Together.AI&quot;</span><span class="p">,</span>
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo&quot;</span><span class="p">,</span>
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.together.xyz/v1&quot;</span><span class="p">,</span>
</span><span id="__span-76-14"><a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a>    <span class="n">input_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0001&quot;</span><span class="p">),</span>
</span><span id="__span-76-15"><a id="__codelineno-76-15" name="__codelineno-76-15" href="#__codelineno-76-15"></a><span class="p">)</span>
</span></code></pre></div>
<h4 id="ollama-local-presets-free">Ollama Local Presets (Free)<a class="headerlink" href="#ollama-local-presets-free" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="n">OLLAMA_LLAMA_70B</span> <span class="o">=</span> <span class="n">LLMSpec</span><span class="p">(</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>    <span class="n">provider</span><span class="o">=</span><span class="n">LLMProvider</span><span class="o">.</span><span class="n">OPENAI_COMPATIBLE</span><span class="p">,</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>    <span class="n">provider_name</span><span class="o">=</span><span class="s2">&quot;Ollama-Local&quot;</span><span class="p">,</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama3.1:70b&quot;</span><span class="p">,</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://localhost:11434/v1&quot;</span><span class="p">,</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>    <span class="n">input_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0&quot;</span><span class="p">),</span>  <span class="c1"># FREE!</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>    <span class="n">output_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0&quot;</span><span class="p">),</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="p">)</span>
</span></code></pre></div>
<h4 id="groq-anthropic-presets">Groq &amp; Anthropic Presets<a class="headerlink" href="#groq-anthropic-presets" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="n">GROQ_LLAMA_70B</span> <span class="o">=</span> <span class="n">LLMSpec</span><span class="p">(</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>    <span class="n">provider</span><span class="o">=</span><span class="n">LLMProvider</span><span class="o">.</span><span class="n">GROQ</span><span class="p">,</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama-3.1-70b-versatile&quot;</span><span class="p">,</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>    <span class="n">input_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.00059&quot;</span><span class="p">),</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="p">)</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="n">CLAUDE_SONNET_4</span> <span class="o">=</span> <span class="n">LLMSpec</span><span class="p">(</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a>    <span class="n">provider</span><span class="o">=</span><span class="n">LLMProvider</span><span class="o">.</span><span class="n">ANTHROPIC</span><span class="p">,</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-sonnet-4-20250514&quot;</span><span class="p">,</span>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a>    <span class="n">max_tokens</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a>    <span class="n">input_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.003&quot;</span><span class="p">),</span>
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a><span class="p">)</span>
</span></code></pre></div>
<h3 id="factory-method-create_custom_openai_compatible">Factory Method: <code>create_custom_openai_compatible()</code><a class="headerlink" href="#factory-method-create_custom_openai_compatible" title="Permanent link">&para;</a></h3>
<p><strong>Purpose</strong>: Simplify custom provider configuration (vLLM, LocalAI, etc.)</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="nd">@classmethod</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_custom_openai_compatible</span><span class="p">(</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>    <span class="bp">cls</span><span class="p">,</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>    <span class="n">provider_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>    <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>    <span class="n">input_cost_per_1k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>    <span class="n">output_cost_per_1k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a>    <span class="o">**</span><span class="n">kwargs</span>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMSpec</span><span class="p">:</span>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for custom OpenAI-compatible providers.&quot;&quot;&quot;</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>    <span class="k">return</span> <span class="n">LLMSpec</span><span class="p">(</span>
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>        <span class="n">provider</span><span class="o">=</span><span class="n">LLMProvider</span><span class="o">.</span><span class="n">OPENAI_COMPATIBLE</span><span class="p">,</span>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a>        <span class="n">provider_name</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>        <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
</span><span id="__span-79-17"><a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a>        <span class="n">input_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_cost_per_1k</span><span class="p">)),</span>
</span><span id="__span-79-18"><a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a>        <span class="n">output_cost_per_1k_tokens</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_cost_per_1k</span><span class="p">)),</span>
</span><span id="__span-79-19"><a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a>        <span class="o">**</span><span class="n">kwargs</span>
</span><span id="__span-79-20"><a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a>    <span class="p">)</span>
</span></code></pre></div>
<h3 id="usage-with-pipelinebuilderwith_llm_spec">Usage with <code>PipelineBuilder.with_llm_spec()</code><a class="headerlink" href="#usage-with-pipelinebuilderwith_llm_spec" title="Permanent link">&para;</a></h3>
<p><strong>New Method</strong>: <code>with_llm_spec(spec: LLMSpec) -&gt; PipelineBuilder</code></p>
<p><strong>Location</strong>: <code>ondine/api/pipeline_builder.py</code> (lines 260-311)</p>
<p><strong>Purpose</strong>: Accept pre-built LLMSpec objects instead of individual parameters</p>
<p><strong>Example Usage</strong>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ondine.core.specifications</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLMProviderPresets</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="c1"># Simple preset usage</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="n">pipeline</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>    <span class="n">PipelineBuilder</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>    <span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="s2">&quot;data.csv&quot;</span><span class="p">,</span> <span class="n">input_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">output_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">])</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>    <span class="o">.</span><span class="n">with_prompt</span><span class="p">(</span><span class="s2">&quot;Process: </span><span class="si">{text}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>    <span class="o">.</span><span class="n">with_llm_spec</span><span class="p">(</span><span class="n">LLMProviderPresets</span><span class="o">.</span><span class="n">TOGETHER_AI_LLAMA_70B</span><span class="p">)</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a><span class="p">)</span>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a><span class="c1"># Override preset settings</span>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a><span class="n">custom</span> <span class="o">=</span> <span class="n">LLMProviderPresets</span><span class="o">.</span><span class="n">GPT4O_MINI</span><span class="o">.</span><span class="n">model_copy</span><span class="p">(</span>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a>    <span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a><span class="p">)</span>
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a><span class="n">pipeline</span><span class="o">.</span><span class="n">with_llm_spec</span><span class="p">(</span><span class="n">custom</span><span class="p">)</span>
</span><span id="__span-80-17"><a id="__codelineno-80-17" name="__codelineno-80-17" href="#__codelineno-80-17"></a>
</span><span id="__span-80-18"><a id="__codelineno-80-18" name="__codelineno-80-18" href="#__codelineno-80-18"></a><span class="c1"># Custom provider via factory</span>
</span><span id="__span-80-19"><a id="__codelineno-80-19" name="__codelineno-80-19" href="#__codelineno-80-19"></a><span class="n">custom_vllm</span> <span class="o">=</span> <span class="n">LLMProviderPresets</span><span class="o">.</span><span class="n">create_custom_openai_compatible</span><span class="p">(</span>
</span><span id="__span-80-20"><a id="__codelineno-80-20" name="__codelineno-80-20" href="#__codelineno-80-20"></a>    <span class="n">provider_name</span><span class="o">=</span><span class="s2">&quot;My vLLM Server&quot;</span><span class="p">,</span>
</span><span id="__span-80-21"><a id="__codelineno-80-21" name="__codelineno-80-21" href="#__codelineno-80-21"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;mistral-7b-instruct&quot;</span><span class="p">,</span>
</span><span id="__span-80-22"><a id="__codelineno-80-22" name="__codelineno-80-22" href="#__codelineno-80-22"></a>    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://my-server:8000/v1&quot;</span><span class="p">,</span>
</span><span id="__span-80-23"><a id="__codelineno-80-23" name="__codelineno-80-23" href="#__codelineno-80-23"></a>    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span>
</span><span id="__span-80-24"><a id="__codelineno-80-24" name="__codelineno-80-24" href="#__codelineno-80-24"></a><span class="p">)</span>
</span><span id="__span-80-25"><a id="__codelineno-80-25" name="__codelineno-80-25" href="#__codelineno-80-25"></a><span class="n">pipeline</span><span class="o">.</span><span class="n">with_llm_spec</span><span class="p">(</span><span class="n">custom_vllm</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="comparison-before-vs-after">Comparison: Before vs After<a class="headerlink" href="#comparison-before-vs-after" title="Permanent link">&para;</a></h3>
<p><strong>Before (parameter-based)</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="o">.</span><span class="n">with_llm</span><span class="p">(</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>    <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;openai_compatible&quot;</span><span class="p">,</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>    <span class="n">provider_name</span><span class="o">=</span><span class="s2">&quot;Together.AI&quot;</span><span class="p">,</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;meta-llama/Meta-Llama-3.1-70B-Instruct-Turbo&quot;</span><span class="p">,</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.together.xyz/v1&quot;</span><span class="p">,</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>    <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;$</span><span class="si">{TOGETHER_API_KEY}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>    <span class="n">input_cost_per_1k_tokens</span><span class="o">=</span><span class="mf">0.0006</span><span class="p">,</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>    <span class="n">output_cost_per_1k_tokens</span><span class="o">=</span><span class="mf">0.0006</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>After (preset-based)</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="o">.</span><span class="n">with_llm_spec</span><span class="p">(</span><span class="n">LLMProviderPresets</span><span class="o">.</span><span class="n">TOGETHER_AI_LLAMA_70B</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Result</strong>: 80% code reduction, zero configuration errors</p>
<h3 id="design-decisions">Design Decisions<a class="headerlink" href="#design-decisions" title="Permanent link">&para;</a></h3>
<p><strong>Why Static Class Instead of Enum?</strong>
- Allows class methods (factory)
- Better IDE autocomplete
- Can include documentation in docstrings
- Easier to extend without breaking existing code</p>
<p><strong>Why No Hardcoded API Keys?</strong>
- Security: API keys should never be in code
- All presets have <code>api_key=None</code> by default
- Users must provide via environment variables or <code>model_copy(update={"api_key": "..."})</code></p>
<p><strong>Why Pydantic <code>model_copy()</code> for Overrides?</strong>
- Immutability: Original presets unchanged
- Type safety: Validation on override
- Pythonic: Standard Pydantic pattern
- Flexible: Override any field</p>
<h3 id="security-validation">Security Validation<a class="headerlink" href="#security-validation" title="Permanent link">&para;</a></h3>
<p><strong>Test</strong>: All presets must have <code>api_key=None</code>
<div class="language-python highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_presets_have_no_api_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Security requirement: No hardcoded API keys.&quot;&quot;&quot;</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>    <span class="n">presets</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>        <span class="n">LLMProviderPresets</span><span class="o">.</span><span class="n">GPT4O_MINI</span><span class="p">,</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>        <span class="n">LLMProviderPresets</span><span class="o">.</span><span class="n">TOGETHER_AI_LLAMA_70B</span><span class="p">,</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>        <span class="c1"># ... all presets</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>    <span class="p">]</span>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>    <span class="k">for</span> <span class="n">preset</span> <span class="ow">in</span> <span class="n">presets</span><span class="p">:</span>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>        <span class="k">assert</span> <span class="n">preset</span><span class="o">.</span><span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span>
</span></code></pre></div></p>
<h3 id="backward-compatibility">Backward Compatibility<a class="headerlink" href="#backward-compatibility" title="Permanent link">&para;</a></h3>
<p><strong>100% backward compatible</strong>: Existing <code>with_llm()</code> method unchanged
<div class="language-python highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="c1"># Old way still works</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="n">pipeline</span><span class="o">.</span><span class="n">with_llm</span><span class="p">(</span><span class="n">provider</span><span class="o">=</span><span class="s2">&quot;openai&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="c1"># New way</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="n">pipeline</span><span class="o">.</span><span class="n">with_llm_spec</span><span class="p">(</span><span class="n">LLMProviderPresets</span><span class="o">.</span><span class="n">GPT4O_MINI</span><span class="p">)</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="c1"># Both methods can be mixed (last call wins)</span>
</span></code></pre></div></p>
<h3 id="testing-coverage">Testing Coverage<a class="headerlink" href="#testing-coverage" title="Permanent link">&para;</a></h3>
<p><strong>26 unit tests</strong> (100% pass):
- Preset configuration validation
- Security checks (no API keys)
- Type safety verification
- <code>with_llm_spec()</code> method tests
- Override via <code>model_copy()</code> tests
- Factory method tests
- Backward compatibility tests</p>
<h3 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h3>
<p><strong>Complete example</strong>: <code>examples/14_provider_presets.py</code>
- Demonstrates all preset usage patterns
- Shows customization via <code>model_copy()</code>
- Compares old vs new approach
- Lists all available presets</p>
<h3 id="future-improvements_7">Future Improvements<a class="headerlink" href="#future-improvements_7" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Add more provider presets (Cohere, AI21, Mistral)</li>
<li>[ ] Add model size variants (405B, 8B, etc.)</li>
<li>[ ] Version-specific presets with deprecation warnings</li>
<li>[ ] Auto-update pricing from provider APIs</li>
<li>[ ] YAML preset files for user-defined presets</li>
</ul>
<hr />
<hr />
<h2 id="56-observability-module">5.6 Observability Module<a class="headerlink" href="#56-observability-module" title="Permanent link">&para;</a></h2>
<h3 id="purpose_9">Purpose<a class="headerlink" href="#purpose_9" title="Permanent link">&para;</a></h3>
<p>Plugin-based observability system that leverages <strong>LlamaIndex's built-in instrumentation</strong> for automatic tracking of all LLM calls.</p>
<h3 id="module-ondineobservability">Module: <code>ondine/observability/</code><a class="headerlink" href="#module-ondineobservability" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>ondine/observability/</code> (9 files, ~600 lines)</p>
<p><strong>Responsibility</strong>: Configure LlamaIndex observability handlers via clean Ondine API</p>
<p><strong>Architecture</strong>: Plugin-based with observer registry</p>
<p><strong>Key Features</strong>:
- <strong>Powered by LlamaIndex</strong>: Leverages battle-tested LlamaIndex observability handlers
- <strong>Automatic instrumentation</strong>: All LLM calls tracked automatically (zero manual instrumentation)
- <strong>Multiple observers</strong>: OpenTelemetry, Langfuse, Logging (can use simultaneously)
- <strong>PII sanitization</strong>: Comprehensive regex-based redaction (custom Ondine feature)
- <strong>Fault-tolerant</strong>: Observer failures never crash the pipeline
- <strong>Clean API</strong>: One-line observer configuration via <code>with_observer()</code></p>
<h3 id="design-philosophy">Design Philosophy<a class="headerlink" href="#design-philosophy" title="Permanent link">&para;</a></h3>
<p><strong>"Don't Reinvent the Wheel"</strong></p>
<p>Ondine delegates LLM call tracking to LlamaIndex's native handlers:
-  LlamaIndex automatically instruments <code>llm.chat()</code> calls
-  Ondine configures these handlers via clean API
-  Minimal code (~600 lines vs. 2000+ for custom implementation)
-  Production-ready, battle-tested
-  Auto-updates when LlamaIndex improves</p>
<h3 id="classes_4">Classes<a class="headerlink" href="#classes_4" title="Permanent link">&para;</a></h3>
<h4 id="pipelineobserver-abstract-base-class"><code>PipelineObserver</code> (Abstract Base Class)<a class="headerlink" href="#pipelineobserver-abstract-base-class" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: <code>ondine/observability/base.py</code></p>
<p><strong>Responsibility</strong>: Define observer interface for pipeline events</p>
<p><strong>Pattern</strong>: Observer Pattern + Plugin Architecture</p>
<p><strong>Methods</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">on_pipeline_start</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Optional</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">on_stage_start</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>     <span class="c1"># Optional</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">on_llm_call</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>        <span class="c1"># REQUIRED (abstract)</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">on_stage_end</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>       <span class="c1"># Optional</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">on_error</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>           <span class="c1"># Optional</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">on_pipeline_end</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>    <span class="c1"># Optional</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">flush</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>                   <span class="c1"># Optional</span>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>                   <span class="c1"># Optional</span>
</span></code></pre></div></p>
<p><strong>Design Decision</strong>: Only <code>on_llm_call()</code> is abstract
- LLM calls are the most critical events
- Other events optional (not all observers need them)</p>
<h4 id="observerregistry-class"><code>ObserverRegistry</code> (Class)<a class="headerlink" href="#observerregistry-class" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: <code>ondine/observability/registry.py</code></p>
<p><strong>Responsibility</strong>: Plugin registry for observer implementations</p>
<p><strong>Pattern</strong>: Registry Pattern with decorator-based registration</p>
<p><strong>Methods</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="nd">@classmethod</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">observer_class</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Register an observer implementation.&quot;&quot;&quot;</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="nd">@classmethod</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">PipelineObserver</span><span class="p">]:</span>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get observer class by name.&quot;&quot;&quot;</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="nd">@classmethod</span>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">list_observers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;List all registered observers.&quot;&quot;&quot;</span>
</span></code></pre></div></p>
<p><strong>Decorator</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="nd">@observer</span><span class="p">(</span><span class="s2">&quot;my_observer&quot;</span><span class="p">)</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">MyObserver</span><span class="p">(</span><span class="n">PipelineObserver</span><span class="p">):</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_llm_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM called: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Auto-registration</strong>: Observers register on import via <code>@observer</code> decorator</p>
<h4 id="opentelemetryobserver-class"><code>OpenTelemetryObserver</code> (Class)<a class="headerlink" href="#opentelemetryobserver-class" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: <code>ondine/observability/observers/opentelemetry_observer.py</code></p>
<p><strong>Responsibility</strong>: Delegate to LlamaIndex's OpenTelemetry handler</p>
<p><strong>Implementation</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="nd">@observer</span><span class="p">(</span><span class="s2">&quot;opentelemetry&quot;</span><span class="p">)</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">OpenTelemetryObserver</span><span class="p">(</span><span class="n">PipelineObserver</span><span class="p">):</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a>        <span class="c1"># Configure LlamaIndex OpenTelemetry handler</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a>        <span class="n">LlamaIndexHandlerManager</span><span class="o">.</span><span class="n">configure_handler</span><span class="p">(</span><span class="s2">&quot;opentelemetry&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_llm_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a>        <span class="c1"># LlamaIndex handles this automatically!</span>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a>        <span class="k">pass</span>
</span></code></pre></div></p>
<p><strong>What LlamaIndex Tracks</strong> (automatic):
-  LLM call spans with prompts, completions
-  Token usage and latency
-  Model information
-  Export to Jaeger, Datadog, Grafana, etc.</p>
<p><strong>Lines of Code</strong>: ~70 (vs. 200+ for custom implementation)</p>
<h4 id="langfuseobserver-class"><code>LangfuseObserver</code> (Class)<a class="headerlink" href="#langfuseobserver-class" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: <code>ondine/observability/observers/langfuse_observer.py</code></p>
<p><strong>Responsibility</strong>: Delegate to LlamaIndex's Langfuse handler</p>
<p><strong>Configuration</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="p">{</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>    <span class="s2">&quot;public_key&quot;</span><span class="p">:</span> <span class="s2">&quot;pk-lf-...&quot;</span><span class="p">,</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>    <span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;sk-lf-...&quot;</span><span class="p">,</span>  <span class="c1"># pragma: allowlist secret</span>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a>    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;https://cloud.langfuse.com&quot;</span>  <span class="c1"># optional</span>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>What LlamaIndex Tracks</strong> (automatic):
-  Full prompts and completions
-  Token usage and costs
-  Latency metrics
-  Model information
-  Trace hierarchy
-  User feedback integration (future)</p>
<p><strong>Lines of Code</strong>: ~85 (vs. 240+ for custom implementation)</p>
<h4 id="loggingobserver-class"><code>LoggingObserver</code> (Class)<a class="headerlink" href="#loggingobserver-class" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: <code>ondine/observability/observers/logging_observer.py</code></p>
<p><strong>Responsibility</strong>: Delegate to LlamaIndex's Simple handler</p>
<p><strong>What LlamaIndex Logs</strong> (automatic):
-  LLM calls with prompts
-  Token usage
-  Latency
-  Console output (no external dependencies)</p>
<p><strong>Lines of Code</strong>: ~70 (vs. 170+ for custom implementation)</p>
<h4 id="llamaindexhandlermanager-class"><code>LlamaIndexHandlerManager</code> (Class)<a class="headerlink" href="#llamaindexhandlermanager-class" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: <code>ondine/observability/llamaindex_handlers.py</code></p>
<p><strong>Responsibility</strong>: Configure LlamaIndex global handlers</p>
<p><strong>Methods</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="nd">@classmethod</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure_handler</span><span class="p">(</span><span class="n">handler_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure a LlamaIndex global handler.&quot;&quot;&quot;</span>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">llama_index.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_global_handler</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>    <span class="k">if</span> <span class="n">handler_type</span> <span class="o">==</span> <span class="s2">&quot;opentelemetry&quot;</span><span class="p">:</span>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>        <span class="n">set_global_handler</span><span class="p">(</span><span class="s2">&quot;opentelemetry&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>    <span class="k">elif</span> <span class="n">handler_type</span> <span class="o">==</span> <span class="s2">&quot;langfuse&quot;</span><span class="p">:</span>
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a>        <span class="n">set_global_handler</span><span class="p">(</span><span class="s2">&quot;langfuse&quot;</span><span class="p">,</span>
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a>            <span class="n">public_key</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;public_key&quot;</span><span class="p">],</span>
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>            <span class="n">secret_key</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;secret_key&quot;</span><span class="p">])</span>
</span><span id="__span-90-12"><a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a>    <span class="k">elif</span> <span class="n">handler_type</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
</span><span id="__span-90-13"><a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a>        <span class="n">set_global_handler</span><span class="p">(</span><span class="s2">&quot;simple&quot;</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Design Decision</strong>: Centralized handler configuration
- Single place to manage LlamaIndex handlers
- Consistent error handling
- Future: Multi-handler support via LlamaIndex dispatcher</p>
<h3 id="pii-sanitization-custom-ondine-feature">PII Sanitization (Custom Ondine Feature)<a class="headerlink" href="#pii-sanitization-custom-ondine-feature" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>ondine/observability/sanitizer.py</code></p>
<p><strong>LlamaIndex doesn't provide this</strong>, so we added it as a custom feature.</p>
<p><strong>Patterns</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="n">PII_PATTERNS</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b&quot;</span><span class="p">,</span>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a>    <span class="s2">&quot;ssn&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\b\d</span><span class="si">{3}</span><span class="s2">-\d</span><span class="si">{2}</span><span class="s2">-\d</span><span class="si">{4}</span><span class="s2">\b&quot;</span><span class="p">,</span>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>    <span class="s2">&quot;credit_card&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\b\d</span><span class="si">{4}</span><span class="s2">[- ]?\d</span><span class="si">{4}</span><span class="s2">[- ]?\d</span><span class="si">{4}</span><span class="s2">[- ]?\d</span><span class="si">{4}</span><span class="s2">\b&quot;</span><span class="p">,</span>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a>    <span class="s2">&quot;phone_us&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\b\d</span><span class="si">{3}</span><span class="s2">[-.]?\d</span><span class="si">{3}</span><span class="s2">[-.]?\d</span><span class="si">{4}</span><span class="s2">\b&quot;</span><span class="p">,</span>
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a>    <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\b(?:api[_-]?key|secret|token)[:\s=]+...&quot;</span><span class="p">,</span>
</span><span id="__span-91-7"><a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a>    <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\b(?:\d{1,3}\.)</span><span class="si">{3}</span><span class="s2">\d{1,3}\b&quot;</span><span class="p">,</span>
</span><span id="__span-91-8"><a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>Functions</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">sanitize_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="s2">&quot;[REDACTED]&quot;</span><span class="p">):</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Replace PII with redaction marker.&quot;&quot;&quot;</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">sanitize_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sanitize LLMCallEvent fields.&quot;&quot;&quot;</span>
</span></code></pre></div></p>
<p><strong>Usage</strong> (future):
<div class="language-python highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="o">.</span><span class="n">with_observer</span><span class="p">(</span><span class="s2">&quot;langfuse&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a>    <span class="s2">&quot;public_key&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a>    <span class="s2">&quot;sanitize_prompts&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Enable PII redaction</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a>    <span class="s2">&quot;custom_patterns&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;account_id&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;ACC-\d</span><span class="si">{6}</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span id="__span-93-5"><a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a><span class="p">})</span>
</span></code></pre></div></p>
<h3 id="integration-with-pipeline">Integration with Pipeline<a class="headerlink" href="#integration-with-pipeline" title="Permanent link">&para;</a></h3>
<p><strong>PipelineBuilder API</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">with_observer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Add observability observer.&quot;&quot;&quot;</span>
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>    <span class="c1"># Validates observer is registered</span>
</span><span id="__span-94-4"><a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a>    <span class="c1"># Stores config for later instantiation</span>
</span><span id="__span-94-5"><a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_observers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">))</span>
</span><span id="__span-94-6"><a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a>    <span class="k">return</span> <span class="bp">self</span>
</span></code></pre></div></p>
<p><strong>Pipeline Initialization</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="c1"># In Pipeline.execute():</span>
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="n">observer_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specifications</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;observers&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="k">for</span> <span class="n">observer_name</span><span class="p">,</span> <span class="n">observer_config</span> <span class="ow">in</span> <span class="n">observer_configs</span><span class="p">:</span>
</span><span id="__span-95-4"><a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>    <span class="n">observer_class</span> <span class="o">=</span> <span class="n">ObserverRegistry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">observer_name</span><span class="p">)</span>
</span><span id="__span-95-5"><a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a>    <span class="n">observer</span> <span class="o">=</span> <span class="n">observer_class</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">observer_config</span><span class="p">)</span>
</span><span id="__span-95-6"><a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a>    <span class="c1"># Observer.__init__() configures LlamaIndex handler</span>
</span><span id="__span-95-7"><a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a>    <span class="c1"># LlamaIndex automatically instruments all subsequent LLM calls!</span>
</span></code></pre></div></p>
<h3 id="how-it-works-complete-flow">How It Works (Complete Flow)<a class="headerlink" href="#how-it-works-complete-flow" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>1. User calls: .with_observer(&quot;langfuse&quot;, config={...})
</span><span id="__span-96-2"><a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a>   &gt; Stored in PipelineBuilder._observers
</span><span id="__span-96-3"><a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a>
</span><span id="__span-96-4"><a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a>2. Pipeline.execute() runs:
</span><span id="__span-96-5"><a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a>   &gt; Instantiates LangfuseObserver(config)
</span><span id="__span-96-6"><a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a>       &gt; LangfuseObserver.__init__() calls:
</span><span id="__span-96-7"><a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a>           &gt; LlamaIndexHandlerManager.configure_handler(&quot;langfuse&quot;, config)
</span><span id="__span-96-8"><a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a>               &gt; set_global_handler(&quot;langfuse&quot;, public_key=..., secret_key=...)
</span><span id="__span-96-9"><a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a>                   &gt; LlamaIndex activates Langfuse instrumentation
</span><span id="__span-96-10"><a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a>
</span><span id="__span-96-11"><a id="__codelineno-96-11" name="__codelineno-96-11" href="#__codelineno-96-11"></a>3. LLM calls happen:
</span><span id="__span-96-12"><a id="__codelineno-96-12" name="__codelineno-96-12" href="#__codelineno-96-12"></a>   &gt; llm_client.invoke(prompt)
</span><span id="__span-96-13"><a id="__codelineno-96-13" name="__codelineno-96-13" href="#__codelineno-96-13"></a>       &gt; self.client.chat([message])  # LlamaIndex LLM
</span><span id="__span-96-14"><a id="__codelineno-96-14" name="__codelineno-96-14" href="#__codelineno-96-14"></a>           &gt; LlamaIndex automatically sends to Langfuse!
</span><span id="__span-96-15"><a id="__codelineno-96-15" name="__codelineno-96-15" href="#__codelineno-96-15"></a>               - Prompt 
</span><span id="__span-96-16"><a id="__codelineno-96-16" name="__codelineno-96-16" href="#__codelineno-96-16"></a>               - Completion 
</span><span id="__span-96-17"><a id="__codelineno-96-17" name="__codelineno-96-17" href="#__codelineno-96-17"></a>               - Tokens 
</span><span id="__span-96-18"><a id="__codelineno-96-18" name="__codelineno-96-18" href="#__codelineno-96-18"></a>               - Cost 
</span><span id="__span-96-19"><a id="__codelineno-96-19" name="__codelineno-96-19" href="#__codelineno-96-19"></a>               - Latency 
</span><span id="__span-96-20"><a id="__codelineno-96-20" name="__codelineno-96-20" href="#__codelineno-96-20"></a>
</span><span id="__span-96-21"><a id="__codelineno-96-21" name="__codelineno-96-21" href="#__codelineno-96-21"></a>4. Pipeline completes:
</span><span id="__span-96-22"><a id="__codelineno-96-22" name="__codelineno-96-22" href="#__codelineno-96-22"></a>   &gt; Observer.flush() and close() called
</span><span id="__span-96-23"><a id="__codelineno-96-23" name="__codelineno-96-23" href="#__codelineno-96-23"></a>       &gt; LlamaIndex flushes buffered events
</span></code></pre></div>
<h3 id="benefits-of-delegating-to-llamaindex">Benefits of Delegating to LlamaIndex<a class="headerlink" href="#benefits-of-delegating-to-llamaindex" title="Permanent link">&para;</a></h3>
<p><strong>Code Reduction</strong>:
- Before: ~2000 lines (custom event system)
- After: ~600 lines (thin wrappers)
- <strong>Savings</strong>: 70% less code to maintain!</p>
<p><strong>Quality</strong>:
-  Battle-tested by LlamaIndex community
-  Production-ready
-  Actively maintained
-  Auto-updates with LlamaIndex</p>
<p><strong>Features</strong> (free from LlamaIndex):
-  Automatic LLM call tracking
-  OpenTelemetry integration
-  Langfuse integration
-  Multiple handler support
-  Future: RAG instrumentation when we add it</p>
<h3 id="dependencies_7">Dependencies<a class="headerlink" href="#dependencies_7" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="c1"># Core (required in pyproject.toml)</span>
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="n">opentelemetry</span><span class="o">-</span><span class="n">api</span><span class="o">&gt;=</span><span class="mf">1.20.0</span>
</span><span id="__span-97-3"><a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a><span class="n">opentelemetry</span><span class="o">-</span><span class="n">sdk</span><span class="o">&gt;=</span><span class="mf">1.20.0</span>
</span><span id="__span-97-4"><a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="n">langfuse</span><span class="o">&gt;=</span><span class="mf">2.0.0</span>
</span><span id="__span-97-5"><a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a>
</span><span id="__span-97-6"><a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a><span class="c1"># Optional exporters</span>
</span><span id="__span-97-7"><a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a><span class="n">opentelemetry</span><span class="o">-</span><span class="n">exporter</span><span class="o">-</span><span class="n">jaeger</span><span class="o">&gt;=</span><span class="mf">1.20.0</span>  <span class="c1"># For Jaeger</span>
</span><span id="__span-97-8"><a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a><span class="n">opentelemetry</span><span class="o">-</span><span class="n">exporter</span><span class="o">-</span><span class="n">otlp</span><span class="o">&gt;=</span><span class="mf">1.20.0</span>    <span class="c1"># For OTLP protocol</span>
</span></code></pre></div>
<h3 id="usage-examples">Usage Examples<a class="headerlink" href="#usage-examples" title="Permanent link">&para;</a></h3>
<p><strong>Simple logging</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="n">pipeline</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-98-2"><a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a>    <span class="n">PipelineBuilder</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</span><span id="__span-98-3"><a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a>    <span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="s2">&quot;data.csv&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span><span id="__span-98-4"><a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a>    <span class="o">.</span><span class="n">with_observer</span><span class="p">(</span><span class="s2">&quot;logging&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{})</span>
</span><span id="__span-98-5"><a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a>    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
</span><span id="__span-98-6"><a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Langfuse (LLM observability)</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="n">pipeline</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-99-2"><a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a>    <span class="n">PipelineBuilder</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</span><span id="__span-99-3"><a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a>    <span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="s2">&quot;data.csv&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span><span id="__span-99-4"><a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a>    <span class="o">.</span><span class="n">with_observer</span><span class="p">(</span><span class="s2">&quot;langfuse&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-99-5"><a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a>        <span class="s2">&quot;public_key&quot;</span><span class="p">:</span> <span class="s2">&quot;pk-lf-...&quot;</span><span class="p">,</span>
</span><span id="__span-99-6"><a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a>        <span class="s2">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;sk-lf-...&quot;</span>
</span><span id="__span-99-7"><a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a>    <span class="p">})</span>
</span><span id="__span-99-8"><a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a>    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
</span><span id="__span-99-9"><a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Multiple observers</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="n">pipeline</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-100-2"><a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a>    <span class="n">PipelineBuilder</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</span><span id="__span-100-3"><a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a>    <span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="s2">&quot;data.csv&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span><span id="__span-100-4"><a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a>    <span class="o">.</span><span class="n">with_observer</span><span class="p">(</span><span class="s2">&quot;langfuse&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="o">...</span><span class="p">})</span>
</span><span id="__span-100-5"><a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a>    <span class="o">.</span><span class="n">with_observer</span><span class="p">(</span><span class="s2">&quot;opentelemetry&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="o">...</span><span class="p">})</span>
</span><span id="__span-100-6"><a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a>    <span class="o">.</span><span class="n">with_observer</span><span class="p">(</span><span class="s2">&quot;logging&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{})</span>
</span><span id="__span-100-7"><a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a>    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
</span><span id="__span-100-8"><a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a><span class="p">)</span>
</span></code></pre></div></p>
<h3 id="thread-safety_2">Thread Safety<a class="headerlink" href="#thread-safety_2" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Thread-safe</strong>: Yes (LlamaIndex handlers are thread-safe)</li>
<li><strong>Fault-tolerant</strong>: Observer failures don't crash pipeline</li>
<li><strong>Isolated</strong>: Each observer runs in try/except block</li>
</ul>
<h3 id="performance_1">Performance<a class="headerlink" href="#performance_1" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Overhead</strong>: &lt;1% (LlamaIndex handles async export)</li>
<li><strong>LLM call tracking</strong>: Automatic, no manual instrumentation</li>
<li><strong>Export</strong>: Batched, non-blocking</li>
</ul>
<h3 id="testing-coverage_1">Testing Coverage<a class="headerlink" href="#testing-coverage_1" title="Permanent link">&para;</a></h3>
<p><strong>Unit tests</strong>:
- Observer registry and @observer decorator
- Handler manager configuration
- PII sanitization patterns</p>
<p><strong>Integration tests</strong>:
- Full pipeline with observers
- Multiple observers simultaneously
- Observer failure isolation
- LlamaIndex auto-instrumentation</p>
<h3 id="known-limitations_7">Known Limitations<a class="headerlink" href="#known-limitations_7" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>One global handler at a time</strong>: LlamaIndex's <code>set_global_handler()</code> is global</li>
<li>Workaround: Last observer wins</li>
<li>Future: Use LlamaIndex's lower-level dispatcher for true multi-observer</li>
<li><strong>No pipeline-level events</strong>: LlamaIndex tracks components, not our batch pipeline</li>
<li>Future: Add custom event handlers for pipeline start/end</li>
</ul>
<h3 id="future-enhancements">Future Enhancements<a class="headerlink" href="#future-enhancements" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Multi-observer support via LlamaIndex dispatcher API</li>
<li>[ ] Pipeline-level event tracking (start, end, metrics)</li>
<li>[ ] PII sanitization integration with handlers</li>
<li>[ ] Custom observer tutorial in docs</li>
<li>[ ] RAG retrieval tracking (when RAG is added)</li>
</ul>
<hr />
<hr />
<h2 id="57-multi-row-batching-new-november-2024">5.7 Multi-Row Batching (NEW - November 2024)<a class="headerlink" href="#57-multi-row-batching-new-november-2024" title="Permanent link">&para;</a></h2>
<h3 id="purpose_10">Purpose<a class="headerlink" href="#purpose_10" title="Permanent link">&para;</a></h3>
<p>Enable processing of N rows in a single API call to achieve 100 speedup for large datasets.</p>
<h3 id="architecture-strategy-pattern-new-stages">Architecture: Strategy Pattern + New Stages<a class="headerlink" href="#architecture-strategy-pattern-new-stages" title="Permanent link">&para;</a></h3>
<p><strong>Design Decision</strong>: Use Strategy Pattern for batch formatting + new pipeline stages for aggregation/disaggregation</p>
<p><strong>Why This Design</strong>:
-  Follows existing Layer 2 pattern (stages are first-class)
-  Strategy Pattern for extensibility (JSON, CSV, XML formats)
-  Single Responsibility (each stage has one job)
-  Backward compatible (only activates when batch_size &gt; 1)</p>
<h3 id="module-ondinestrategies">Module: <code>ondine/strategies/</code><a class="headerlink" href="#module-ondinestrategies" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>ondine/strategies/</code> (4 files, ~150 lines)</p>
<p><strong>Responsibility</strong>: Batch formatting strategies for multi-row processing</p>
<h4 id="classes_5">Classes<a class="headerlink" href="#classes_5" title="Permanent link">&para;</a></h4>
<p><strong><code>BatchFormattingStrategy</code> (Abstract Base Class)</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">BatchFormattingStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a>    <span class="nd">@abstractmethod</span>
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-101-4"><a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format N prompts into 1 batch prompt.&quot;&quot;&quot;</span>
</span><span id="__span-101-5"><a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a>        <span class="k">pass</span>
</span><span id="__span-101-6"><a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a>
</span><span id="__span-101-7"><a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a>    <span class="nd">@abstractmethod</span>
</span><span id="__span-101-8"><a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse_batch_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expected_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-101-9"><a id="__codelineno-101-9" name="__codelineno-101-9" href="#__codelineno-101-9"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse 1 batch response into N individual results.&quot;&quot;&quot;</span>
</span><span id="__span-101-10"><a id="__codelineno-101-10" name="__codelineno-101-10" href="#__codelineno-101-10"></a>        <span class="k">pass</span>
</span></code></pre></div></p>
<p><strong><code>JsonBatchStrategy</code> (Concrete Implementation)</strong>:
- Formats prompts as JSON array: <code>[{"id": 1, "input": "..."}, ...]</code>
- Parses responses as JSON array: <code>[{"id": 1, "result": "..."}, ...]</code>
- Uses Pydantic models for validation (BatchItem, BatchResult)
- Handles partial failures (PartialParseError with parsed_results + failed_ids)
- Extracts JSON from markdown code blocks automatically</p>
<p><strong><code>BatchItem</code>, <code>BatchResult</code>, <code>BatchMetadata</code> (Pydantic Models)</strong>:
- Type-safe batch request/response structure
- Validation with Pydantic
- Sorting by ID, missing ID detection</p>
<h3 id="stage-batchaggregatorstage">Stage: <code>BatchAggregatorStage</code><a class="headerlink" href="#stage-batchaggregatorstage" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>ondine/stages/batch_aggregator_stage.py</code></p>
<p><strong>Responsibility</strong>: Aggregate N prompts into 1 mega-prompt</p>
<p><strong>Flow</strong>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a>Input: PromptBatch with N prompts
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a>  
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>Group into chunks of batch_size
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>  
</span><span id="__span-102-5"><a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a>For each chunk:
</span><span id="__span-102-6"><a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a>  - Validate against context window
</span><span id="__span-102-7"><a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a>  - Use strategy.format_batch() to create mega-prompt
</span><span id="__span-102-8"><a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a>  - Create new PromptBatch with 1 mega-prompt
</span><span id="__span-102-9"><a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a>  
</span><span id="__span-102-10"><a id="__codelineno-102-10" name="__codelineno-102-10" href="#__codelineno-102-10"></a>Output: PromptBatch with 1 prompt (containing N rows)
</span></code></pre></div></p>
<p><strong>Key Features</strong>:
- Context window validation (checks model limits)
- Strategy injection (supports JSON, CSV, etc.)
- Preserves row IDs in metadata for disaggregation
- Zero cost (aggregation is free)</p>
<h3 id="stage-batchdisaggregatorstage">Stage: <code>BatchDisaggregatorStage</code><a class="headerlink" href="#stage-batchdisaggregatorstage" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>ondine/stages/batch_disaggregator_stage.py</code></p>
<p><strong>Responsibility</strong>: Split 1 mega-response into N individual responses</p>
<p><strong>Flow</strong>:
<div class="language-text highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a>Input: ResponseBatch with 1 mega-response
</span><span id="__span-103-2"><a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a>  
</span><span id="__span-103-3"><a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a>Check if batch response (metadata.is_batch)
</span><span id="__span-103-4"><a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a>  
</span><span id="__span-103-5"><a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a>Use strategy.parse_batch_response()
</span><span id="__span-103-6"><a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a>  
</span><span id="__span-103-7"><a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a>Handle 3 scenarios:
</span><span id="__span-103-8"><a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a>  1. Full success: All N results parsed
</span><span id="__span-103-9"><a id="__codelineno-103-9" name="__codelineno-103-9" href="#__codelineno-103-9"></a>  2. Partial success: Some results parsed (PartialParseError)
</span><span id="__span-103-10"><a id="__codelineno-103-10" name="__codelineno-103-10" href="#__codelineno-103-10"></a>  3. Complete failure: No results parsed (ValueError)
</span><span id="__span-103-11"><a id="__codelineno-103-11" name="__codelineno-103-11" href="#__codelineno-103-11"></a>  
</span><span id="__span-103-12"><a id="__codelineno-103-12" name="__codelineno-103-12" href="#__codelineno-103-12"></a>Create ResponseBatch with N individual responses
</span><span id="__span-103-13"><a id="__codelineno-103-13" name="__codelineno-103-13" href="#__codelineno-103-13"></a>  
</span><span id="__span-103-14"><a id="__codelineno-103-14" name="__codelineno-103-14" href="#__codelineno-103-14"></a>Output: ResponseBatch with N responses
</span></code></pre></div></p>
<p><strong>Error Handling</strong>:
- <strong>Full success</strong>: Returns N results
- <strong>Partial failure</strong>: Parses what works, marks failed rows with <code>[PARSE_ERROR]</code>
- <strong>Complete failure</strong>: Marks all rows with <code>[BATCH_PARSE_ERROR]</code></p>
<h3 id="utility-model_context_limitspy">Utility: <code>model_context_limits.py</code><a class="headerlink" href="#utility-model_context_limitspy" title="Permanent link">&para;</a></h3>
<p><strong>Location</strong>: <code>ondine/utils/model_context_limits.py</code></p>
<p><strong>Responsibility</strong>: Model context window registry and validation</p>
<p><strong>Registry</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="n">MODEL_CONTEXT_LIMITS</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a>    <span class="s2">&quot;gpt-4o&quot;</span><span class="p">:</span> <span class="mi">128000</span><span class="p">,</span>
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a>    <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">:</span> <span class="mi">128000</span><span class="p">,</span>
</span><span id="__span-104-4"><a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a>    <span class="s2">&quot;claude-sonnet-4&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span>
</span><span id="__span-104-5"><a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a>    <span class="s2">&quot;llama-3.1-70b-versatile&quot;</span><span class="p">:</span> <span class="mi">131072</span><span class="p">,</span>
</span><span id="__span-104-6"><a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a>    <span class="c1"># ... 50+ models</span>
</span><span id="__span-104-7"><a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a><span class="p">}</span>
</span></code></pre></div></p>
<p><strong>Functions</strong>:
- <code>get_context_limit(model)</code> - Get context window for model
- <code>validate_batch_size(model, batch_size, avg_tokens)</code> - Validate batch fits in context
- <code>suggest_optimal_batch_size(model, avg_tokens)</code> - Suggest optimal batch size</p>
<h3 id="pipeline-integration">Pipeline Integration<a class="headerlink" href="#pipeline-integration" title="Permanent link">&para;</a></h3>
<p><strong>Conditional Stage Insertion</strong> (<code>ondine/api/pipeline.py</code>):
<div class="language-python highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="c1"># Stage 2: Format prompts</span>
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="n">formatter</span> <span class="o">=</span> <span class="n">PromptFormatterStage</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a><span class="n">batches</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-105-4"><a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a>
</span><span id="__span-105-5"><a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a><span class="c1"># Stage 2.5: Aggregate (only if batch_size &gt; 1)</span>
</span><span id="__span-105-6"><a id="__codelineno-105-6" name="__codelineno-105-6" href="#__codelineno-105-6"></a><span class="k">if</span> <span class="n">specs</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-105-7"><a id="__codelineno-105-7" name="__codelineno-105-7" href="#__codelineno-105-7"></a>    <span class="n">aggregator</span> <span class="o">=</span> <span class="n">BatchAggregatorStage</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">specs</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span><span id="__span-105-8"><a id="__codelineno-105-8" name="__codelineno-105-8" href="#__codelineno-105-8"></a>    <span class="n">batches</span> <span class="o">=</span> <span class="n">aggregator</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-105-9"><a id="__codelineno-105-9" name="__codelineno-105-9" href="#__codelineno-105-9"></a>
</span><span id="__span-105-10"><a id="__codelineno-105-10" name="__codelineno-105-10" href="#__codelineno-105-10"></a><span class="c1"># Stage 3: Invoke LLM</span>
</span><span id="__span-105-11"><a id="__codelineno-105-11" name="__codelineno-105-11" href="#__codelineno-105-11"></a><span class="n">llm_stage</span> <span class="o">=</span> <span class="n">LLMInvocationStage</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-105-12"><a id="__codelineno-105-12" name="__codelineno-105-12" href="#__codelineno-105-12"></a><span class="n">response_batches</span> <span class="o">=</span> <span class="n">llm_stage</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-105-13"><a id="__codelineno-105-13" name="__codelineno-105-13" href="#__codelineno-105-13"></a>
</span><span id="__span-105-14"><a id="__codelineno-105-14" name="__codelineno-105-14" href="#__codelineno-105-14"></a><span class="c1"># Stage 3.5: Disaggregate (only if batch_size &gt; 1)</span>
</span><span id="__span-105-15"><a id="__codelineno-105-15" name="__codelineno-105-15" href="#__codelineno-105-15"></a><span class="k">if</span> <span class="n">specs</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-105-16"><a id="__codelineno-105-16" name="__codelineno-105-16" href="#__codelineno-105-16"></a>    <span class="n">disaggregator</span> <span class="o">=</span> <span class="n">BatchDisaggregatorStage</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-105-17"><a id="__codelineno-105-17" name="__codelineno-105-17" href="#__codelineno-105-17"></a>    <span class="n">response_batches</span> <span class="o">=</span> <span class="n">disaggregator</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">response_batches</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span><span id="__span-105-18"><a id="__codelineno-105-18" name="__codelineno-105-18" href="#__codelineno-105-18"></a>
</span><span id="__span-105-19"><a id="__codelineno-105-19" name="__codelineno-105-19" href="#__codelineno-105-19"></a><span class="c1"># Stage 4: Parse responses</span>
</span><span id="__span-105-20"><a id="__codelineno-105-20" name="__codelineno-105-20" href="#__codelineno-105-20"></a><span class="n">parser_stage</span> <span class="o">=</span> <span class="n">ResponseParserStage</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-105-21"><a id="__codelineno-105-21" name="__codelineno-105-21" href="#__codelineno-105-21"></a><span class="n">results</span> <span class="o">=</span> <span class="n">parser_stage</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">response_batches</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Design Decision</strong>: Conditional insertion (not always present)
- <strong>Why</strong>: Zero overhead when batch_size=1 (default)
- <strong>How</strong>: Check <code>specs.prompt.batch_size &gt; 1</code> before inserting stages
- <strong>Benefit</strong>: Backward compatible, opt-in only</p>
<h3 id="api-pipelinebuilder">API: PipelineBuilder<a class="headerlink" href="#api-pipelinebuilder" title="Permanent link">&para;</a></h3>
<p><strong>New Methods</strong>:
<div class="language-python highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">with_batch_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PipelineBuilder&quot;</span><span class="p">:</span>
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enable multi-row batching (process N rows per API call).&quot;&quot;&quot;</span>
</span><span id="__span-106-3"><a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_spec</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
</span><span id="__span-106-4"><a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a>    <span class="k">return</span> <span class="bp">self</span>
</span><span id="__span-106-5"><a id="__codelineno-106-5" name="__codelineno-106-5" href="#__codelineno-106-5"></a>
</span><span id="__span-106-6"><a id="__codelineno-106-6" name="__codelineno-106-6" href="#__codelineno-106-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">with_batch_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PipelineBuilder&quot;</span><span class="p">:</span>
</span><span id="__span-106-7"><a id="__codelineno-106-7" name="__codelineno-106-7" href="#__codelineno-106-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set batch formatting strategy (&#39;json&#39; or &#39;csv&#39;).&quot;&quot;&quot;</span>
</span><span id="__span-106-8"><a id="__codelineno-106-8" name="__codelineno-106-8" href="#__codelineno-106-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_spec</span><span class="o">.</span><span class="n">batch_strategy</span> <span class="o">=</span> <span class="n">strategy</span>
</span><span id="__span-106-9"><a id="__codelineno-106-9" name="__codelineno-106-9" href="#__codelineno-106-9"></a>    <span class="k">return</span> <span class="bp">self</span>
</span><span id="__span-106-10"><a id="__codelineno-106-10" name="__codelineno-106-10" href="#__codelineno-106-10"></a>
</span><span id="__span-106-11"><a id="__codelineno-106-11" name="__codelineno-106-11" href="#__codelineno-106-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">with_processing_batch_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PipelineBuilder&quot;</span><span class="p">:</span>
</span><span id="__span-106-12"><a id="__codelineno-106-12" name="__codelineno-106-12" href="#__codelineno-106-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set internal batch size for PromptFormatterStage (internal optimization).&quot;&quot;&quot;</span>
</span><span id="__span-106-13"><a id="__codelineno-106-13" name="__codelineno-106-13" href="#__codelineno-106-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_processing_spec</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="__span-106-14"><a id="__codelineno-106-14" name="__codelineno-106-14" href="#__codelineno-106-14"></a>    <span class="k">return</span> <span class="bp">self</span>
</span></code></pre></div></p>
<p><strong>Naming Clarification</strong>:
- <code>with_batch_size()</code> - Multi-row batching (NEW, 100 speedup)
- <code>with_processing_batch_size()</code> - Internal batching (OLD, renamed)</p>
<h3 id="specifications">Specifications<a class="headerlink" href="#specifications" title="Permanent link">&para;</a></h3>
<p><strong>PromptSpec</strong> (added fields):
<div class="language-python highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PromptSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a>    <span class="c1"># ... existing fields ...</span>
</span><span id="__span-107-3"><a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Multi-row batching</span>
</span><span id="__span-107-4"><a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a>    <span class="n">batch_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>  <span class="c1"># &quot;json&quot; or &quot;csv&quot;</span>
</span></code></pre></div></p>
<h3 id="performance-characteristics_3">Performance Characteristics<a class="headerlink" href="#performance-characteristics_3" title="Permanent link">&para;</a></h3>
<p><strong>Benchmarks</strong> (verified with real OpenAI API):
- <strong>Without batching</strong> (batch_size=1): 10 rows = 10 API calls
- <strong>With batching</strong> (batch_size=5): 10 rows = 2 API calls (5 reduction)
- <strong>With batching</strong> (batch_size=100): 5M rows = 50K API calls (100 reduction!)</p>
<p><strong>Scaling to 5M Rows</strong>:
| Batch Size | API Calls | Time | Speedup |
|------------|-----------|------|---------|
| 1 (default) | 5,000,000 | ~69 hours | 1 |
| 10 | 500,000 | ~7 hours | 10 |
| 100 | 50,000 | ~42 minutes | 100 |
| 500 | 10,000 | ~8 minutes | 500 |</p>
<p><strong>Limitations</strong>:
- Batch size limited by model context window (auto-validated)
- Larger batches = higher risk of partial failures
- JSON parsing overhead (~200 tokens per batch)</p>
<h3 id="testing_3">Testing<a class="headerlink" href="#testing_3" title="Permanent link">&para;</a></h3>
<p><strong>Unit Tests</strong> (24 tests):
- <code>test_batch_strategies.py</code> - 16 tests for strategies
- <code>test_batch_stages.py</code> - 8 tests for stages</p>
<p><strong>Integration Tests</strong> (5 tests):
- <code>test_batch_processing_openai.py</code> - Real OpenAI API tests
- Verified 5 reduction with batch_size=5
- Verified backward compatibility (batch_size=1)</p>
<p><strong>Coverage</strong>: 60% overall, 84% for batch disaggregator, 71% for batch aggregator</p>
<h3 id="examples_1">Examples<a class="headerlink" href="#examples_1" title="Permanent link">&para;</a></h3>
<p><strong>Example</strong>: <code>examples/21_multi_row_batching.py</code>
- Example 1: Without batching (baseline)
- Example 2: With batching (5 speedup)
- Example 3: Large dataset extrapolation (5.4M rows)</p>
<h3 id="known-limitations_8">Known Limitations<a class="headerlink" href="#known-limitations_8" title="Permanent link">&para;</a></h3>
<ul>
<li>JSON strategy only (CSV planned for future)</li>
<li>No automatic retry for failed rows (marks with error, user must retry)</li>
<li>Batch size validation is warning-only (doesn't block)</li>
<li>Requires LLM to follow JSON format instructions</li>
</ul>
<h3 id="future-improvements_8">Future Improvements<a class="headerlink" href="#future-improvements_8" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Implement CsvBatchStrategy (more compact than JSON)</li>
<li>[ ] Automatic retry for failed rows within batch</li>
<li>[ ] Adaptive batch sizing based on prompt length</li>
<li>[ ] XML/YAML batch strategies</li>
<li>[ ] Batch size optimization suggestions based on historical data</li>
</ul>
<hr />
<p><strong>Document Status</strong>: IN PROGRESS (Layer 0 complete, Layer 1 documented with MLX, Presets, Observability, and Multi-Row Batching)</p>
<p><strong>Next Sections</strong>:
- 3.6 <code>utils/logging_utils.py</code>
- 3.7 <code>utils/metrics_exporter.py</code>
- 3.8 <code>utils/input_preprocessing.py</code>
- Part 4: Core Models &amp; Specifications
- Part 5: Complete Layer 1 (remaining providers)
- Part 6+: Remaining layers...</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/ptimizeroracle/ondine" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "navigation.path", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>