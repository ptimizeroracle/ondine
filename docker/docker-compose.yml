services:
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    volumes:
      - ..:/app
    working_dir: /app
    environment:
      # LiteLLM & OTel Configuration
      - LITELLM_LOG=INFO
      - OTEL_EXPORTER=otlp_http
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      - OTEL_SERVICE_NAME=ondine-profiling
      # Langfuse Configuration (Local)
      - LANGFUSE_HOST=http://langfuse-server:3000
      # Pass-through environment variables for keys
      - LANGFUSE_PUBLIC_KEY
      - LANGFUSE_SECRET_KEY
      - PYTHONUNBUFFERED=1
    depends_on:
      - jaeger
      - langfuse-server

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686" # UI
      - "4318:4318"   # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true

  # Langfuse Services
  langfuse-server:
    # Pin to a specific stable version to avoid recent regression/bug (ZodError)
    image: langfuse/langfuse:2
    depends_on:
      - langfuse-db
      - clickhouse
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@langfuse-db:5432/postgres
      # Disable cluster mode for Clickhouse to avoid Zookeeper requirement
      - CLICKHOUSE_URL=http://clickhouse:8123
      - CLICKHOUSE_MIGRATION_URL=clickhouse://clickhouse:9000
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=password
      - NEXTAUTH_SECRET=mysecret
      - SALT=mysalt
      - NEXTAUTH_URL=http://localhost:3000
      - TELEMETRY_ENABLED=false
      # Allow signup to create your initial admin account
      - NEXT_PUBLIC_SIGN_UP_DISABLED=false
      # IMPORTANT: Disable Clickhouse clustering for simple local setup
      - CLICKHOUSE_CLUSTER_ENABLED=false

  langfuse-db:
    image: postgres:16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    volumes:
      - langfuse_db_data:/var/lib/postgresql/data

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=password
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    volumes:
      - langfuse_clickhouse_data:/var/lib/clickhouse
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

volumes:
  langfuse_db_data:
  langfuse_clickhouse_data:
